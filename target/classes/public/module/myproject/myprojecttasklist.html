<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
    <!--/_only 独立样式 -->
</head>
<style type="text/css">
    body {
        font-family: '微软雅黑', sans-serif;
        font-size: 12px;
    }

    .sClass {
        text-align: center;
    }

</style>
<body>
<div class="page-container" style="padding: 2px;">
    <div class="f-l text-l" id="addbtn">
        <span class="dropDown dropDown_hover">
              <a class="dropDown_A btn btn-default-outline my-btn" onclick="addtask(1)">  新建子任务</a>
              <ul class="dropDown-menu menu radius box-shadow">
                <li><a href="#" onclick="Values()"><i class=" fa fa-plus"></i> 新建母任务</a></li>
              </ul>
        </span>
    </div>
<!--    <div class="f-r text-r">-->

<!--        <input type="text" class="input-text size-S form-text-FName" style="width:200px" placeholder="任务名称">-->

<!--        <button type="button" class="btn btn-default size-S my-btn btn-search-fun"><i class="Hui-iconfont">&#xe665;</i>-->
<!--            搜索-->
<!--        </button>-->
<!--    </div>-->
    <div class="f-l" style="width: 100%; margin-top: 3px;">
        <strong>提示：点击行信息进行选中</strong>
        <table class="table table-striped table-bordered table-hover" id="treetable" style="width: 100%"></table>
    </div>
</div>
<script src="/module/elemantary/js/jquery.json.min.js"></script>
<script src="/module/elemantary/js/jquery.json.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script src="/module/elemantary/js/dataTables.treeGrid.js"></script>
<script type="text/javascript">
    var dataTable = null;
    var tree;
    var id = getQueryStringByName('id'); // 项目ID
    var xmname = parent.xmname; //项目名称
    var rmname;
    var paramvalue = "";

    var pfstate = -2;
    var showtype = getQueryStringByName('showtype'); //显示类型 1=项目管理 2=项目执行 3=项目预警 4=项目检索
    var columns_list=[];
    // 业务代码
    $(function () {



        $.fn.dataTable.ext.errMode = 'throw';

        //获取项目状态
        $.ajax({
            type: 'POST',
            contentType: 'application/json',
            url: '/s/myproject/getmyprojectstate', // 调用地址
            data: JSON.stringify({
                id:id
            }),
            async: false,
            success: function (data) {
                pfstate = data.pfstate;
            },
            error: function (e) {
                toastr.error(e.status);
                toastr.error(e.responseText);
            }
        });


        if(pfstate==1){
            columns_list = [
                {
                    className: '',
                    title: "选择",

                    data: function (item) {
                        return '<input onclick="xuanzhong(\''+item.key+'\',\''+item.FName+'\')" type="radio" name="cscheck" id="r' + item.key + '"  value="' + item.key + '">';
                    }, "width": 10
                },
                {
                    className: 'treegrid-control',

                    title: "展开/收缩",

                    data: function (item) {
                        if (item.children != null && item.children.length > 0) {
                            return '<span><i class="fa fa-plus" ></i></span>';
                        }
                        return '';
                    }, "width": 40
                },
                // {"data": "FName", "title": '任务名称', "width": 180, class: 'open-work-control2'},
                // {"data": "FNo", "title": '任务编号', "width": 50, class: 'open-work-control2'},
                {"data": "FNo", "title": '任务编号', "width": 80, class: 'open-work-control2'},　
                {"data": "FMNo", "title": '制号', "width": 150, class: 'open-work-control2'},
                // {"data": "FMName", "title": '工序号/工序名称', "width": 120, class: 'open-work-control2'},
                {"data": "FMTypeName", "title": '制件类型', "width": 60, class: 'open-work-control2'},
                {"data": "FLeadUserID", "title": '负责人', "width": 30, class: 'open-work-control2'},
                {"data": "FStateName", "title": '状态', "width": 30, class: 'open-work-control2'},
                {"data": "FJHDate", "title": '计划时间', "width": 70, class: 'open-work-control2'},
                {"data": "FWCDate", "title": '完成时间', "width": 60, class: 'open-work-control2'},
                {
                    "data": "", "title": '浏览', "width": 60, class: 'open-work-control2'
                    , orderable: false,
                    render: function (data, type, row) {
                        // if(pfstate ==0){
                        //     if(row.FState == 0){
                        return '<button  class="btn size-MINI " onclick="inputtask(\'' + row.key + '\',\'' + row.FName + '\')" >前往任务管理</button>&nbsp;';
                        //     }else{
                        //         return '<button  class="btn size-MINI disabled"  >前往任务管理</button>&nbsp;';
                        //     }
                        //
                        // }else{
                        //     return '<button  class="btn size-MINI disabled"  >前往任务管理</button>&nbsp;';
                        // }

                    }
                },
                // {
                //     "data": "", "title": '操作', "width": 60, class: 'open-work-control2'
                //     , orderable: false,
                //     render: function (data, type, row) {
                //
                //         if(pfstate ==0){
                //             if(row.FState==0){
                //                 return '<button  class="btn btn-secondary size-MINI " onclick="updatecell(\'' + row.key + '\',\'' + row.FFID + '\')" ><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                //                     '<button  class="btn btn-danger size-MINI " onclick="del(\'' + row.key + '\')"><i class="fas fa-trash"></i>删除</button>&nbsp;';
                //             }else{
                //                 return '<button  class="btn btn-secondary size-MINI disabled"><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                //                     '<button  class="btn btn-danger size-MINI disabled" ><i class="fas fa-trash"></i>删除</button>&nbsp;';
                //             }
                //         }else{
                //             return '<button  class="btn btn-secondary size-MINI disabled"><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                //                 '<button  class="btn btn-danger size-MINI disabled" ><i class="fas fa-trash"></i>删除</button>&nbsp;';
                //         }
                //     }
                // }
            ];
        }else{
            columns_list = [
                {
                    className: '',
                    title: "选择",

                    data: function (item) {
                        return '<input onclick="xuanzhong(\''+item.key+'\',\''+item.FName+'\')" type="radio" name="cscheck" id="r' + item.key + '"  value="' + item.key + '">';
                    }, "width": 10
                },
                {
                    className: 'treegrid-control',

                    title: "展开/收缩",

                    data: function (item) {
                        if (item.children != null && item.children.length > 0) {
                            return '<span><i class="fa fa-plus" ></i></span>';
                        }
                        return '';
                    }, "width": 40
                },
                // {"data": "FName", "title": '任务名称', "width": 180, class: 'open-work-control2'},
                // {"data": "FNo", "title": '任务编号', "width": 50, class: 'open-work-control2'},
                {"data": "FNo", "title": '任务编号', "width": 80, class: 'open-work-control2'},
                {"data": "FMNo", "title": '制号', "width": 150, class: 'open-work-control2'},
                // {"data": "FMName", "title": '工序号/工序名称', "width": 120, class: 'open-work-control2'},
                {"data": "FMTypeName", "title": '制件类型', "width": 60, class: 'open-work-control2'},
                {"data": "FLeadUserID", "title": '负责人', "width": 30, class: 'open-work-control2'},
                {"data": "FStateName", "title": '状态', "width": 30, class: 'open-work-control2'},

                {"data": "FCDATE", "title": '创建时间', "width": 60, class: 'open-work-control2'},
                {
                    "data": "", "title": '浏览', "width": 60, class: 'open-work-control2'
                    , orderable: false,
                    render: function (data, type, row) {
                        // if(pfstate ==0){
                        //     if(row.FState == 0){
                        return '<button  class="btn size-MINI " onclick="inputtask(\'' + row.key + '\',\'' + row.FName + '\')" >前往任务管理</button>&nbsp;';
                        //     }else{
                        //         return '<button  class="btn size-MINI disabled"  >前往任务管理</button>&nbsp;';
                        //     }
                        //
                        // }else{
                        //     return '<button  class="btn size-MINI disabled"  >前往任务管理</button>&nbsp;';
                        // }

                    }
                },
                {
                    "data": "", "title": '操作', "width": 90, class: 'open-work-control2'
                    , orderable: false,
                    render: function (data, type, row) {

                        if(pfstate ==0){
                            if(row.FState==0){
                                return '<button  class="btn btn-secondary size-MINI " onclick="updatecell(\'' + row.key + '\',\'' + row.FFID + '\')" ><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                                    '<button  class="btn btn-danger size-MINI " onclick="del(\'' + row.key + '\')"><i class="fas fa-trash"></i>删除</button>&nbsp;';
                            }else{
                                return '<button  class="btn btn-secondary size-MINI disabled"><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                                    '<button  class="btn btn-danger size-MINI disabled" ><i class="fas fa-trash"></i>删除</button>&nbsp;';
                            }
                        }else{
                            return '<button  class="btn btn-secondary size-MINI disabled"><i class="fas fa-edit"></i>编辑</button>&nbsp;' +
                                '<button  class="btn btn-danger size-MINI disabled" ><i class="fas fa-trash"></i>删除</button>&nbsp;';
                        }
                    }
                }
            ];
        }


        dataTable = $('#treetable').DataTable({
            /**
             l - Length changing 改变每页显示多少条数据的控件
             f - Filtering input 即时搜索框控件
             t - The Table 表格本身
             i - Information 表格相关信息控件
             p - Pagination 分页控件
             r - pRocessing 加载等待显示信息
             **/
            "dom": "tr",
            "ordering": false, //禁用排序
            "processing": true,
            "serverSide": true,
            "destroy": true,
            //"data":data.datalist,
            "ajax": {
                async: false,
                type: 'POST',
                contentType: 'application/json',
                url: '/s/ttask/showTaskTableTree', // 调用地址
                data: function (d) {
                    return JSON.stringify($.extend({}, d, {
                        id: id
                    }));
                },
                dataSrc: function (json) {
                    return json.datalist2 ? json.datalist2.data : [];
                },
                error: function (xhr, status, error) {
                    toastr.error(xhr);
                }

            },
            "columns": columns_list,
            "columnDefs": [
                {
                    "defaultContent": "",
                    "targets": "_all"
                }
            ],
            language: DataTablesLanguage
        });

        tree = new $.fn.dataTable.TreeGrid(dataTable, {
            left: 15,
            expandAll: true,
            expandIcon: '<span><i class="fa fa-plus" ></i></span>',
            collapseIcon: '<span><i class="fa fa-minus" ></i></span>'
        });

        if(showtype ==1 ){
            if(pfstate < 2 ){
                $("#addbtn").attr("style", "display:block;"); //显示
            }else{
                $("#addbtn").attr("style", "display:none;");  //隐藏
            }
        }else{
            $("#addbtn").attr("style", "display:none;");  //隐藏
        }
        //点击项目信息显示
        $('#treetable tbody').on('click', 'tr td.open-work-control2', function () {

            if (!$(this).parent().hasClass('selected')) { // 处理点击行样式
                dataTable.$('tr.selected').removeClass('selected');
                $(this).parent().addClass('selected');
            }
            var data = dataTable.row(this).data(); // 获取点击行数据
            if (!$("#r" + data.key).prop('checked')) {
                $("#r" + data.key).prop('checked', true);//全选

            } else {
                $("#r" + data.key).prop('checked', false);//取消全选
            }
            paramvalue = $("input[name='cscheck']:checked").val();
            rmname = data.FName;
        });

        expandAll();
    });

    function expandAll() {
        tree.expandAll();
    }

    function collapseAll() {
        tree.collapseAll();
    }

    function reload() {
        dataTable.ajax.reload();
        $("#r" + paramvalue).prop('checked', true);//全选
    }

    function reloads() {
        dataTable.ajax.reload();
        paramvalue = "";
    }

    function draw() {
        dataTable.draw(false);
    }

    function addtask() {

        if (paramvalue == undefined || paramvalue == "" || paramvalue == null) {
            toastr.error("请选择一个任务进行添加！");
        } else {
            layer_show('新增子任务信息', 'myprojecttaskeditz.html?op=1&FProjectID=' + id + '&FFID=' + paramvalue, '1000', '450');
        }
    }

    function Values() {
        //先查一下是否有根节点
        // $.ajax({
        //     type: 'POST',
        //     contentType: 'application/json',
        //     url: '/s/ttask/queryttaskgen', // 调用地址
        //     data: JSON.stringify({
        //         FProjectID: id
        //     }),
        //     async: false,
        //     success: function (data) {
        //         if (data.result == 'success') {
        //             if (data.isgen == 0) {
        //
        //             } else {
        //                 toastr.warning('已存在根节点，不能重复添加！');
        //             }
        //         } else if (data.result == 'error') {
        //             toastr.error(data.error);
        //         }
        //     },
        //     error: function (e) {
        //         toastr.error(e.status);
        //         toastr.error(e.responseText);
        //     }
        // });
        layer_show('新增任务信息', 'myprojecttaskeditg.html?op=1&FProjectID=' + id, '1000', '550');

    }

    //修改
    function updatecell(key, ffid) {
        if (ffid == -1) {
            layer_show('修改任务信息', 'myprojecttaskeditg.html?op=2&FProjectID=' + id + '&id=' + key, '1000', '550');
        } else {
            layer_show('修改子任务信息', 'myprojecttaskeditz.html?op=2&FProjectID=' + id + '&id=' + key, '1000', '550');
        }
    }


    function del(key) {
        layer.confirm('确定要删除选中的任务及子任务吗？', function (index) {
            $("body").mLoading("show");
            layer.close(layer.index);
            setTimeout(function () {
                $('.mloading-text').html('数据删除中...');
                setTimeout(function () {
                    $('.mloading-text').html('数据删除中...');
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/ttask/delttask', // 调用地址
                        data: JSON.stringify({
                            id: key,
                            FProjectID: id
                        }),
                        async: false,
                        success: function (data) {
                            if (data.result == 'success') {
                                setTimeout(function () {
                                    $('.mloading-text').html('删除数据完成...');
                                    reloads();
                                    setTimeout(function () {
                                        $("body").mLoading("hide");
                                    }, 1000);
                                }, 1000);

                            } else if (data.result == 'error') {
                                console.log(data.error);
                                toastr.error(data.error);
                                $("body").mLoading("hide");
                            }
                        },
                        error: function (e) {
                            toastr.error(e.status);
                            toastr.error(e.responseText);
                        }
                    });
                }, 1000);
            }, 1000)


        });
    }
    function inputtask(taskid,taskname) {
        top.creatIframe('/module/mytask/mytasklist.html?taskid='+taskid+'&showtype=1&lang=zh&sidebar-entries=large','我的任务管理');
    }
    function xuanzhong(key,name) {
        if ($("#r" + key).prop('checked')) {
            $("#r" + key).prop('checked', true);//全选

        } else {
            $("#r" + key).prop('checked', false);//取消全选
        }
        paramvalue = $("input[name='cscheck']:checked").val();
        rmname = name;
    }
</script>
</body>
</html>