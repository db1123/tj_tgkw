<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="renderer" content="webkit|ie-comp|ie-stand">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport"
              content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
        <meta http-equiv="Cache-Control" content="no-siteapp"/>
        <!--_global 公共配置文件 -->
        <script language="javascript">var golbal_type = "admin";</script>
        <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
        <!--_only 独立样式 -->
        <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
        <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
        <!--/_only 独立样式 -->


    </head>
    <style type="text/css">
        body {
            font-family: '微软雅黑', sans-serif;
            font-size: 12px;
        }

        .sClass {
            text-align: center;
        }

    </style>
    <body>
        <div class="page-container" style="padding: 2px;">
            <div class="f-l text-l">
                <button type="button" class="btn btn-default size-S my-btn " id="xinjianlingjian"
                        onclick="newmateiallingjian()">
                    <!--            <a data-href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large" data-title="BOM管理" href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large">-->
                    ①新建零件
                    <!--            </a>-->
                </button>
                <button type="button" class="btn btn-default size-S my-btn " id="xinjianmuju"
                        onclick="newmateialmuju()">
                    <!--            <a data-href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large" data-title="BOM管理" href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large">-->
                    ②新建模具
                    <!--            </a>-->
                </button>
                <button type="button" class="btn btn-default size-S my-btn" onclick="mobanOut(1)"><i
                        class="fa fa-arrow-down" aria-hidden="true"/></i> 下载模板
                </button>
                <!--        <button type="button" class="btn btn-default size-S my-btn " id="xinjian" onclick="newmateial()" >-->
                <!--&lt;!&ndash;            <a data-href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large" data-title="BOM管理" href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large">&ndash;&gt;-->
                <!--                新建产品-->
                <!--&lt;!&ndash;            </a>&ndash;&gt;-->
                <!--        </button>-->
                <!--        <button type="button" class="btn btn-default size-S my-btn　" id="updatecp" onclick="updatemateial()" >-->
                <!--            &lt;!&ndash;            <a data-href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large" data-title="BOM管理" href="/module/bom/bom/list.html?lang=zh&sidebar-entries=large">&ndash;&gt;-->
                <!--            编辑当前产品-->
                <!--            &lt;!&ndash;            </a>&ndash;&gt;-->
                <!--        </button>-->
                <!--        <button type="button" class="btn btn-default size-S my-btn " id="oldcp" onclick="selectmaterial()">-->
                <!--            选择已有产品-->
                <!--        </button>-->
            </div>
            <div class="f-l" style="width: 98.8%; margin-top: 1px;">
                <div class="panel panel-default">
                    <div class="panel-header">模具列表：<strong class="bominfo"></strong></div>
                    <div class="panel-body">
                        <table class="table table-striped table-bordered table-hover" id="treetable"
                               style="width: 100%"></table>
                        <a id="downloada" download="" href="" target="_blank" style="display: none"><span
                                id="downloadspan">下载文件</span></a>
                    </div>
                </div>
            </div>
        </div>
        <script src="/module/elemantary/js/jquery.json.min.js"></script>
        <script src="/module/elemantary/js/jquery.json.js"></script>
        <script src="/plugins/select2/js/select2.full.min.js"></script>
        <script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
        <script src="/module/elemantary/js/dataTables.treeGrid.js"></script>
        <script type="text/javascript">
            var dataTable = null;
            var tree;
            var xmfaid = 0;
            var paramlist = [];
            var FBomState;//bomm状态
            var FEditionNo; //版本号
            var FEdition;//版本
            var genid;//根节点id
            var ftype = 1;
            var copyid = 0;//复制的ID
            var pastelist = []; //粘贴到的ID下面 (设想可以选择多个)
            var shownum = -1;
            var statenum = -1;
            var FProjectID = getQueryStringByName('id');//项目ID
            var isFMatertial = getQueryStringByName('isFMatertial');//项目产品 是否存在
            var xmname = parent.xmname;
            var showtype = getQueryStringByName('showtype'); //显示类型 1=项目管理 2=项目执行 3=项目预警

            var MaterialID = 0;//当前项目挂的产品ID


            var pfstate = -2;//项目状态
            var culomnslist1 = [];
            var pmaterial = -2;//0 未绑定产品 1 已绑定产品

            top.myprojectmaterial = this;
            var FLJID;
            var FLJName;
            var isguanbi = -2;
            // 业务代码
            $(function () {
                //获取项目状态
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    url: '/s/myproject/getmyprojectstate', // 调用地址
                    data: JSON.stringify({
                        id: FProjectID
                    }),
                    async: false,
                    success: function (data) {
                        pfstate = data.pfstate;
                        pmaterial = data.pmaterial;
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
                // if (pmaterial == 1) {
                //
                //     $('#xinjianmuju').removeClass('disabled'); //移除多个样式　
                //     $('#xinjianlingjian').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                // } else {
                //     $('#xinjianmuju').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                //     $('#xinjianlingjian').removeClass('disabled'); //移除多个样式　
                // }
                if (pfstate < 2) {
                    culomnslist1 = [
                        {
                            className: 'treegrid-control',
                            title: "展开/收缩",
                            data: function (item) {
                                if (item.children != null && item.children.length > 0) {
                                    return '<span><i class="fa fa-plus" ></i></span>';
                                }
                                return '';
                            }, "width": 40
                        },
                        // {"data": "FName","title": 'BOM行信息',"width": 250,class: 'open-work-control2'},
                        {"data": "FMNo", "title": '零件号（制号）', "width": 250, class: 'open-work-control2'},
                        {"data": "FMName", "title": '零件名称(工序号/工序名称)', "width": 250, class: 'open-work-control2'},
                        {"data": "FModel", "title": '型号', "width": 70, class: 'open-work-control2'},
                        {"data": "FSpecs", "title": '规格', "width": 70, class: 'open-work-control2'},
                        {"data": "FTexture", "title": '材料', "width": 70, class: 'open-work-control2'},
                        {"data": "FSize", "title": '尺寸', "width": 70, class: 'open-work-control2'},
                        {"data": "FOutside", "title": '外观', "width": 70, class: 'open-work-control2'},

                        // {"data": "FType", "title": '标/非标', "width": 50, class: 'open-work-control2'},
                        // {"data": "FFrom", "title": '来源', "width": 60, class: 'open-work-control2'},
                        // {"data": "FMType", "title": '类型', "width": 30, class: 'open-work-control2'},
                        // {"data": "num", "title": '数量', "width": 30, class: 'open-work-control2'},
                        // {"data": "FUnitID", "title": '单位', "width": 60, class: 'open-work-control2'},
                        {
                            title: '操作',
                            data: 'FState',
                            class: 'open-work-control2',
                            width: 160,
                            orderable: false,
                            render: function (data, type, row) {
                                if (row.edit == 1) {
                                    return '<button type="button" class="btn btn-secondary size-MINI" onclick="updatexx(\'' + row.key + '\',\'' + row.FMID + '\')"><i class="fas fa-edit"></i>编辑</button>' +
                                        '&nbsp;<button type="button" class="btn btn-danger size-MINI"  onclick="del(\'' + row.key + '\',\'' + row.FMName + '\')"><i class="fas fa-trash"></i>删除</button>';
                                } else {
                                    return '<button type="button" class="btn btn-secondary size-MINI" onclick="updatexx2(\'' + row.key + '\',\'' + row.FMID + '\')"><i class="fas fa-edit"></i>编辑</button>'
                                        + '&nbsp;<button type="button" class="btn btn-secondary size-MINI" onclick="mojuIn(\'' + row.key + '\',\'' + row.FMID + '\',\'' + row.FMName + '\')"><i class="fa fa-reply-all" aria-hidden="true" /></i>导入模具</button>'
                                }

                            }
                        }
                    ];
                } else {
                    culomnslist1 = [
                        {
                            className: 'treegrid-control',
                            title: "展开/收缩",
                            data: function (item) {
                                if (item.children != null && item.children.length > 0) {
                                    return '<span><i class="fa fa-plus" ></i></span>';
                                }
                                return '';
                            }, "width": 40
                        },
                        // {"data": "FName","title": 'BOM行信息',"width": 250,class: 'open-work-control2'},

                        // {"data": "FMNo", "title": '模具编号', "width": 250, class: 'open-work-control2'},
                        // {"data": "FMName", "title": '模具名称', "width": 250, class: 'open-work-control2'},
                        // {"data": "FType", "title": '标/非标', "width": 50, class: 'open-work-control2'},
                        // {"data": "FFrom", "title": '来源', "width": 60, class: 'open-work-control2'},
                        // {"data": "FMType", "title": '类型', "width": 30, class: 'open-work-control2'},
                        // {"data": "num", "title": '数量', "width": 30, class: 'open-work-control2'},
                        // {"data": "FUnitID", "title": '单位', "width": 60, class: 'open-work-control2'}
                        {"data": "FMNo", "title": '零件号（制号）', "width": 250, class: 'open-work-control2'},
                        {"data": "FMName", "title": '零件名称(工序号/工序名称)', "width": 250, class: 'open-work-control2'},
                        {"data": "FModel", "title": '型号', "width": 70, class: 'open-work-control2'},
                        {"data": "FSpecs", "title": '规格', "width": 70, class: 'open-work-control2'},
                        {"data": "FTexture", "title": '材料', "width": 70, class: 'open-work-control2'},
                        {"data": "FSize", "title": '尺寸', "width": 70, class: 'open-work-control2'},
                        {"data": "FOutside", "title": '外观', "width": 70, class: 'open-work-control2'},
                    ];
                }

                $.fn.dataTable.ext.errMode = 'throw';
                dataTable = $('#treetable').DataTable({
                    /**
                     l - Length changing 改变每页显示多少条数据的控件
                     f - Filtering input 即时搜索框控件
                     t - The Table 表格本身
                     i - Information 表格相关信息控件
                     p - Pagination 分页控件
                     r - pRocessing 加载等待显示信息
                     **/
                    "dom": "tr",
                    "ordering": false, //禁用排序
                    "processing": true,
                    "serverSide": true,
                    "destroy": true,
                    //"data":data.datalist,
                    "ajax": {
                        async: false,
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/myproject/showBomTableTreeProjectYC', // 调用地址
                        data: function (d) {
                            return JSON.stringify($.extend({}, d, {
                                FProjectID: FProjectID
                            }));
                        },
                        dataSrc: function (json) {
                            FBomState = json.FBomState ? json.FBomState : "";
                            FEditionNo = json.FEditionNo ? json.FEditionNo : "";
                            FEdition = json.FEdition ? json.FEdition : "";
                            genid = json.genid ? json.genid : 0;
                            MaterialID = json.MaterialID ? json.MaterialID : 0;

                            var texts = json.FBomName ? json.FBomName + "/" + FEdition + "(" + FBomState + ")" : "";
                            $(".bominfo").text(texts);
                            return json.datalist2 ? json.datalist2.data : [];
                        },
                        error: function (xhr, status, error) {
                            toastr.error(xhr);
                        }

                    },
                    "columns": culomnslist1,
                    "columnDefs": [
                        {
                            "defaultContent": "",
                            "targets": "_all"
                        }
                    ],
                    language: DataTablesLanguage
                });
                tree = new $.fn.dataTable.TreeGrid(dataTable, {
                    left: 15,
                    expandAll: true,
                    expandIcon: '<span><i class="fa fa-plus" ></i></span>',
                    collapseIcon: '<span><i class="fa fa-minus" ></i></span>'
                });
                tree.expandAll();


                if (showtype == 1 || showtype == 2) {
                    if (pfstate == 0) {
                        $('#xinjian').removeClass('disabled'); //移除多个样式
                        $('#updatecp').removeClass('disabled'); //移除多个样式
                        $('#oldcp').removeClass('disabled'); //移除多个样式　
                    } else {
                        if (pfstate == 1) {
                            $('#updatecp').removeClass('disabled'); //移除多个样式
                        } else {
                            $('#xinjian').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                            $('#updatecp').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                            $('#oldcp').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式　
                        }

                    }
                } else {
                    $('#xinjian').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                    $('#updatecp').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                    $('#oldcp').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式　
                }
            });

            function expandAll() {
                tree.expandAll();
            }

            function collapseAll() {
                tree.collapseAll();
            }

            function reload() {
                dataTable.ajax.reload();
                // $('#xinjianlingjian').addClass('btn btn-default size-S my-btn disabled'); //追加多个样式
                // $('#xinjianmuju').removeClass('disabled'); //移除多个样式　
            }

            function draw() {
                dataTable.draw(false);
            }

            function selectmaterial() {

                if (isFMatertial == 1) {
                    var text = '检测到已有产品，是否重新选择？';
                    layer.confirm(text, function (index) {
                        layer.close(layer.index);
                        layer_show('选择产品', 'myprojectmaterialSelect.html?id=' + FProjectID, '600', '300');

                    });
                } else {
                    layer_show('选择产品', 'myprojectmaterialSelect.html?id=' + FProjectID, '600', '300');
                }
            }

            function newmateial() {
                top.creatIframe('/module/bom/bom/list.html?lang=zh&sidebar-entries=large', '产品结构管理');
            }

            function updatemateial() {
                top.creatIframe('/module/bom/bom/list.html?fmid=' + MaterialID + '&lang=zh&sidebar-entries=large', '产品结构管理');
            }

            function newmateiallingjian() {
                if (pfstate < 2) {
                    //layer_show('新建模具信息', 'myprojectmaterialpartedit.html?FProjectID=' + FProjectID, '1000', '400');
                    //top.layer_show('①新建零件信息', '/module/myproject/myprojectmaterialnewpart.html?FProjectID=' + FProjectID, '1000', '400');

                    top.layer.open({
                        type: 2,
                        area: ['1000px', '400px'],
                        fix: false, //不固定
                        shade: 0.4,
                        title: '①新建零件信息',
                        content: '/module/myproject/myprojectmaterialnewpart.html?op=1&FProjectID=' + FProjectID
                        , end: function (index, layero) {
                            if (isguanbi == 2) {
                                $('body').mLoading('show');
                                setTimeout(function () {
                                    $('.mloading-text').html('正在打开模具面板...');
                                    setTimeout(function () {
                                        top.layer_show('②新建模具信息', '/module/myproject/myprojectmaterialnewpart_mj.html?FProjectID=' + FProjectID + '&FLJName=' + FLJName + '&FLJID=' + FLJID, '', '');
                                        $("body").mLoading("hide");
                                    }, 1000);
                                }, 1000);
                                // top.layer_show('②新建模具信息', '/module/myproject/myprojectmaterialnewpart_mj.html?FProjectID=' + FProjectID, '', '');
                            }
                        }
                    });

                } else {
                    toastr.error('项目已完成，不允许操作！');
                }
            }

            function newmateialmuju() {
                if (pfstate < 2) {
                    top.layer_show('②新建模具信息', '/module/myproject/myprojectmaterialnewpart_mj.html?FProjectID=' + FProjectID, '', '');
                } else {
                    toastr.error('项目已完成，不允许操作！');
                }
            }

            function updatexx(fkey, fmid) {
                //修改模具名称
                if (pfstate < 2) {
                    layer_show('修改模具信息', 'myprojectmaterialnewpart_upmj.html?id=' + fkey + '&FProjectID=' + FProjectID + '&FMID=' + fmid, '1000', '400');
                } else {
                    toastr.error('项目已完成，不允许操作！');
                }

            }

            function updatexx2(fkey, fmid) {
                //修改模具名称
                if (pfstate < 2) {
                    layer_show('修改零件信息', 'myprojectmaterialnewpart.html?op=2&id=' + fkey + '&FProjectID=' + FProjectID + '&FMID=' + fmid, '1000', '400');
                } else {
                    toastr.error('项目已完成，不允许操作！');
                }
            }


            function del(fkey, name) {
                if (pfstate < 2) {
                    layer.confirm('<b>' + name + '</b><br />确定要删除吗，并且删除相关联的模具任务?', function (index) {
                        $('body').mLoading('show');
                        $.ajax({
                            type: 'POST',
                            contentType: 'application/json;charset=UTF-8',
                            url: '/s/material/delmyprojectmaterialmojuboms',
                            data: JSON.stringify({
                                id: fkey,//boms id
                                FProjectID: FProjectID
                            }),
                            success: function (data) {
                                if (data.result == 'success') {
                                    toastr.success('删除成功！');
                                    reload();
                                    layer.close(layer.index);
                                    $("body").mLoading("hide");
                                }
                                if (data.result == 'error') {
                                    toastr.error(data.error);
                                    $("body").mLoading("hide");
                                }
                            },
                            error: function (e) {
                                toastr.error(e.status);
                                toastr.error(e.responseText);
                                $("body").mLoading("hide");
                            }
                        });
                    });
                } else {
                    toastr.error('项目已完成，不允许操作！');
                }

            }


            function mojuIn(fbomsid, fmid, fmname) {
                layer_show('导入模具信息', 'myprojectmaterialMjIn.html?id=' + fbomsid + '&fmid=' + fmid + '&fmname=' + fmname + '&FProjectID=' + FProjectID, '800', '300');
            }

            function mobanOut() {
                $("body").mLoading("show");
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/tDesignPurchaseApplyMaterialmaterial/downloadMoban',
                    data: JSON.stringify({
                        filenamestr:"模具信息导入模板",
                        filename: "myprojectmaterialmj.xlsx",
                        ip: '39.102.232.225:9193',
                    }),
                    success: function (data) {
                        if (data.result == 'success') {

                            setTimeout(function () {
                                $('.mloading-text').html('正在获取文件信息...');
                                $("#downloada").attr('download', data.filename);
                                $("#downloada").attr('href', data.file);
                                setTimeout(function () {
                                    $('.mloading-text').html('获取完成准备下载...');
                                    $("#downloadspan").trigger("click");
                                    setTimeout(function () {
                                        $('#mainTable').DataTable().ajax.reload(null, false);
                                        $("body").mLoading("hide");
                                    }, 1000);
                                }, 1000);
                            }, 1000);

                        }
                        if (data.result == 'error') {
                            toastr.error(data.error);
                            $("body").mLoading("hide");
                        }

                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }
        </script>
    </body>
</html>