<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <!--_only 独立样式 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
    <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
    <link rel="stylesheet" href="/plugins/daterangepicker/daterangepicker.css">
    <!--/_only 独立样式 -->
</head>
<body>
<article class="page-container">
    <form action="" method="post" class="form form-horizontal" id="projecttaskForm">
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>项目名称：</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" name="FProjectName" id="FProjectName" disabled="disabled" />
            </div>
        </div>
<!--        <div class="row cl">-->
<!--            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>模具：</label>-->
<!--            <div class="formControls col-xs-3 col-sm-4">-->
<!--                <select name="FMaterialID" id="FMaterialID" class="" style="width: 100%;"></select>-->
<!--            </div>-->
<!--        </div>-->
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>任务名称：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <input type="text" class="input-text" name="FName" id="FName"/>
            </div>
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>任务编号：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <input type="text" class="input-text" name="FNo" id="FNo"/>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>负责人：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <select name="FLeadUserID" id="FLeadUserID" class="" style="width: 100%;"></select>
            </div>
            <label class="form-label col-xs-3 col-sm-2">任务要求：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <input type="text" class="input-text" name="FAsk" id="FAsk"/>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>任务类型：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <select name="FTypeID" id="FTypeID" class="" style="width: 100%;"></select>
            </div>
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>制件类型：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <select name="FMType" id="FMType" class="" style="width: 100%;"></select>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>计划开始：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <input type="text" class="input-text" name="FSDate" id="FSDate" readonly="readonly"/>
            </div>
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>计划完成：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <input type="text" class="input-text" name="FEDate" id="FEDate" readonly="readonly"/>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2"><span class="c-red">*</span>里程碑：</label>
            <div class="formControls col-xs-3 col-sm-4">
                <select style="width: 100%" name="FISMilepost" id="FISMilepost">
                    <option value="0">否</option>
                    <option value="1">是</option>
                </select>
            </div>
        </div>
        <div class="row cl">
            <label class="form-label col-xs-3 col-sm-2">备注：</label>
            <div class="formControls col-xs-8 col-sm-10">
                <input type="text" class="input-text" name="FNote" id="FNote"/>
            </div>
        </div>
        <div class="toolbar-bottom-line"></div>
        <div class="toolbar-bottom-btn">
            <input class="btn btn-primary radius mr-20" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;"/>
            <input class="btn btn-default radius ml-20" type="button" value="&nbsp;&nbsp;取消&nbsp;&nbsp;"
                   onclick="layer_close()"/>
        </div>
        <input type="hidden" value="" name="FProjectID" id="FProjectID"/>
        <input type="hidden" value="" name="FKeyID" id="FKeyID"/>
    </form>
</article>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript" src="/plugins/moment/moment.min.js"></script>
<script type="text/javascript" src="/plugins/daterangepicker/daterangepicker.js"></script>
<script type="text/javascript">
    // 编辑框状态 1新建 2修改
    var op = getQueryStringByName('op');
    var FProjectID = getQueryStringByName('FProjectID');
    var xmname = parent.xmname; //项目名称
    // 业务代码
    $(function () {
        $("#FProjectID").val(FProjectID);
        $("#FProjectName").val(xmname);
        // 初始化下拉菜单---------------------------------------------------------------------------------
        //  计划开始
        $("#projecttaskForm input[name='FSDate']").daterangepicker({
            singleDatePicker: true, // 设置为单日历，即无区间 默认false
            showDropdowns: true, // 当设置值为true时，允许年份和月份通过下拉框的形式选择 默认false
            autoUpdateInput: false, // 1.当设置为false的时候,不给与默认值(当前时间) 2.选择时间时,失去鼠标焦点,不会给与默认值 默认true
            timePicker24Hour: true, // 设置小时为24小时制 默认false
            timePicker: false, // 可选中时分 默认false
            locale: {
                format: "YYYY-MM-DD",
                separator: " - ",
                daysOfWeek: ["日", "一", "二", "三", "四", "五", "六"],
                monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"]
            }
        }).on('apply.daterangepicker', function (ev, picker) {
            $("#projecttaskForm input[name='FSDate']").val(picker.startDate.format('YYYY-MM-DD'));
        });


        //  计划开始
        $("#projecttaskForm input[name='FEDate']").daterangepicker({
            singleDatePicker: true, // 设置为单日历，即无区间 默认false
            showDropdowns: true, // 当设置值为true时，允许年份和月份通过下拉框的形式选择 默认false
            autoUpdateInput: false, // 1.当设置为false的时候,不给与默认值(当前时间) 2.选择时间时,失去鼠标焦点,不会给与默认值 默认true
            timePicker24Hour: true, // 设置小时为24小时制 默认false
            timePicker: false, // 可选中时分 默认false
            autoApply: true,
            locale: {
                format: "YYYY-MM-DD",
                separator: " - ",
                daysOfWeek: ["日", "一", "二", "三", "四", "五", "六"],
                monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"]
            }
        }).on('apply.daterangepicker', function (ev, picker) {
            $("#projecttaskForm input[name='FEDate']").val(picker.startDate.format('YYYY-MM-DD'));
        });
        $("#FISMilepost").select2({
            placeholder: '请选择是否为里程碑',
            language: "zh-CN"
        });
        $("#projecttaskForm select[name='FLeadUserID']").select2({
            placeholder: '请选择负责人',
            ajax: {
                type: 'POST',
                url: "/s/user/queryDataUserSelect",
                dataType: 'json',
                data: function (params) {
                    return {
                        search: params.term,
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                delay: 800,
                cache: true
            },
            language: "zh-CN"
        });
        $("#projecttaskForm select[name='FMType']").select2({
            placeholder: '请选择制件类型',
            ajax: {
                type: 'POST',
                url: "/s/taskmaketype/queryDatataskmaketypeSelect",
                dataType: 'json',
                data: function (params) {
                    return {
                        search: params.term,
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.list
                    };
                },
                delay: 800,
                cache: true
            },
            language: "zh-CN"
        });
        $("#projecttaskForm select[name='FTypeID']").select2({
            placeholder: '请选择任务类型',
            ajax: {
                type: 'POST',
                url: "/s/tasktype/queryDatatasktypeSelect",
                dataType: 'json',
                data: function (params) {
                    return {
                        search: params.term,
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.list
                    };
                },
                delay: 800,
                cache: true
            },
            language: "zh-CN"
        });

        // $("#projecttaskForm select[name='FMaterialID']").select2({
        //     placeholder: '请选择模具',
        //     ajax: {
        //         type: 'POST',
        //         url: "/s/material/queryDatamaterialSelectprojectID",
        //         dataType: 'json',
        //         data: function (params) {
        //             return {
        //                 search: params.term,
        //                 FProjectID:FProjectID
        //             };
        //         },
        //         processResults: function (data) {
        //             return {
        //                 results: data.list
        //             };
        //         },
        //         delay: 800,
        //         cache: true
        //     },
        //     language: "zh-CN"
        // });
        // if(op==2){
        //     $("#projecttaskForm select[name='FMaterialID']").change(function(){
        //         $('body').mLoading('show');
        //         var p1=$(this).children('option:selected').val();//这就是selected的值
        //         // console.log(p1);
        //         //根据选择的零部件 生成任务名称和任务编号
        //         $.ajax({
        //             type: 'POST',
        //             contentType: 'application/json',
        //             url: '/s/myproject/myprojectttaskNoName', // 调用地址
        //             data: JSON.stringify({
        //                 id:p1
        //             }),
        //             async: false,
        //             success: function (data) {
        //                 $("#FName").val(data.FRWName);
        //                 $("#FNo").val(data.FRWNo);
        //             },
        //             error: function (e) {
        //                 toastr.error(e.status);
        //                 toastr.error(e.responseText);
        //             }
        //         });
        //         $("body").mLoading("hide");
        //     });
        // }





        if(op==2){
            var id = getQueryStringByName('id');
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: '/s/ttask/queryttaskInfo', // 调用地址
                data: JSON.stringify({
                    id: id
                }),
                async: false,
                success: function(data) {
                    $('#FName').val(data.info.FName);
                    $('#FNo').val(data.info.FNo);
                    $('#FAsk').val(data.info.FAsk);
                    $('#FNote').val(data.info.FNote);
                    var option3 = new Option(data.info.FLeadUserName, data.info.FLeadUserID, true, true);
                    $("#FLeadUserID").append(option3);
                    $("#FLeadUserID").change();
                    option3 = new Option(data.info.FTypeName, data.info.FTypeID, true, true);
                    $("#FTypeID").append(option3);
                    $("#FTypeID").change();
                    // option3 = new Option(data.info.FMaterialName, data.info.FMaterialID, true, true);
                    // $("#FMaterialID").append(option3);
                    // $("#FMaterialID").change();
                    option3 = new Option(data.info.FMTypeName, data.info.FMType, true, true);
                    $("#FMType").append(option3);
                    $("#FMType").change();
                    option3 = new Option(data.info.FISMilepostName, data.info.FISMilepost, true, true);
                    $("#FISMilepost").append(option3);
                    $("#FISMilepost").change();
                    $("#projecttaskForm input[name='FSDate']").val(data.info.FSDate);
                    $("#projecttaskForm input[name='FEDate']").val(data.info.FEDate);
                    $('#FKeyID').val(data.info.key);
                },
                error : function(e) {
                    toastr.error(e.status);
                    toastr.error(e.responseText);
                }
            });
        }
        // jQuery.validator.methods.compareDate = function(value, element, param) {
        //     //var startDate = jQuery(param).val() + ":00";补全yyyy-MM-dd HH:mm:ss格式
        //     //value = value + ":00";
        //
        //     var startDate = jQuery(param).val();
        //
        //     var date1 = new Date(Date.parse(startDate.replace("-", "/")));
        //     var date2 = new Date(Date.parse(value.replace("-", "/")));
        //     return date1 < date2;
        // };

        jQuery.validator.addMethod("compareDate", function (value, element, param) {
            var startDate = $("#projecttaskForm input[name='FSDate']").val();

            var date1 = new Date(Date.parse(startDate.replace("-", "/")));
            var date2 = new Date(Date.parse(value.replace("-", "/")));
            if(date2>=date1){
                return true;
            }else{
                return false;
            }

        }, $.validator.format("计划完成时间必须大于计划开始时间!"));
        // 检验数据
        var userValidate = $('#projecttaskForm').validate({
            rules: {
                FName: {
                    required: true,
                    levelLimit: false
                },
                FNo: {
                    required: true,
                    levelLimit: false
                },
                FTypeID: {
                    required: true,
                    levelLimit: false
                },
                FLeadUserID: {
                    required: true,
                    levelLimit: false
                },
                FSDate: {
                    required: true,
                    levelLimit: false
                },
                FEDate: {
                    required: true,
                    levelLimit: false,
                    compareDate: true
                },
                // FMaterialID: {
                //     required: true,
                //     levelLimit: false
                // },
                FISMilepost: {
                    required: true,
                    levelLimit: false
                },
                FMType: {
                    required: true,
                    levelLimit: false
                },

            },
            messages: {
                FName: {
                    required: '*请输入任务名称'
                },
                FNo: {
                    required: '*请输入任务编号'
                },
                FTypeID: {
                    required: '*请选择任务类型'
                },
                FLeadUserID: {
                    required: '*请选择负责人'
                },
                FSDate: {
                    required: '*请选择计划开始时间'
                },
                FEDate: {
                    required: '*请选择计划完成时间',
                    // compareDate: "计划完成时间必须大于计划开始时间!"
                },
                // FMaterialID: {
                //     required: '*请选择模具'
                // },
                FISMilepost: {
                    required: '*请选择里程碑'
                },
                FMType: {
                    required: '*请选择制件类型'
                },

            },
            onfocusout: false, // 是否在获取焦点时验证
            onkeyup: false, // 是否在敲击键盘时验证
            focusInvalid: false, //提交表单后，（第一个）未通过验证的表单获得焦点
            focusCleanup: true, // 当未通过验证的元素获得焦点时，移除错误提示
            success: 'valid',
            submitHandler: function () {
                // 获取参数
                var data = form2Json('projecttaskForm');
                if (op == 1) { // 添加操作
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/ttask/addttask', // 调用地址
                        data: JSON.stringify(data),
                        async: false,
                        success: function (data) {
                            if (data.result == 'success') {
                                parent.reload();
                                parent.toastr.success('添加成功！');
                                layer_close();
                            } else if (data.result == 'fail') {
                                toastr.warning('任务编号重复，请重新输入');
                            } else if (data.result == 'error') {
                                toastr.error(data.error);
                            }
                        },
                        error: function (e) {
                            toastr.error(e.status);
                            toastr.error(e.responseText);
                        }
                    });
                }else{
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/ttask/updatettask', // 调用地址
                        data: JSON.stringify(data),
                        async: false,
                        success: function (data) {
                            if (data.result == 'success') {
                                parent.reload();
                                parent.toastr.success('修改成功！');
                                layer_close();
                            } else if (data.result == 'fail') {
                                toastr.warning('任务编号重复，请重新输入');
                            } else if (data.result == 'error') {
                                toastr.error(data.error);
                            }
                        },
                        error: function (e) {
                            toastr.error(e.status);
                            toastr.error(e.responseText);
                        }
                    });
                }
            }
        });
    });
</script>
</body>
</html>