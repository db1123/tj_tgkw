<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="renderer" content="webkit|ie-comp|ie-stand">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport"
              content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
        <meta http-equiv="Cache-Control" content="no-siteapp"/>
        <!--_global 公共配置文件 -->
        <script language="javascript">var golbal_type = "admin";</script>
        <script type="text/javascript" src="/javascript/global.js"></script>
        <script type="text/javascript" src="/javascript/reconnecting-websocket.min.js"></script>
        <!--/_global 公共配置文件-->
    </head>
    <body>
        <header class="navbar-wrapper">
            <div class="navbar navbar-fixed-top" style="background: #0F3460;">
                <div class="container-fluid cl">
                    <a id="logo-title" class="logo navbar-logo f-l mr-10 hidden-xs"
                       style="font-weight: 600; font-family: 微软雅黑;" href="/module/main.html"></a>
                    <a id="logo-title-mini" class="logo navbar-logo-m f-l mr-10 visible-xs"
                       style="font-weight: 600; font-family: 微软雅黑;" href="/module/main.html"></a>
                    <a aria-hidden="false" class="nav-toggle Hui-iconfont visible-xs" href="javascript:;">&#xe667;</a>
                    <nav id="Hui-userbar" class="nav navbar-nav navbar-userbar hidden-xs">
                        <ul class="cl">
                            <li class="dropDown dropDown_hover">
                                <a href="#" class="dropDown_A"><i class="fas fa-user-alt"
                                                                  style="width: 28px;"></i>欢迎，<span
                                        id="sys_login_name"></span> <i class="Hui-iconfont">&#xe6d5;</i></a>
                                <ul class="dropDown-menu menu radius box-shadow">
                                    <li><a href="#" id="userInfoEdit"><i class="fas fa-address-card"
                                                                         style="width: 18px;"></i> 修改用户信息</a></li>
                                    <li><a href="#" id="passwordEdit"><i class="fas fa-wrench" style="width: 18px;"></i>
                                        修改密码</a></li>
                                    <li><a href="#" id="logOut"><i class="fas fa-power-off" style="width: 18px;"></i>
                                        退出登录</a></li>
                                </ul>
                            </li>
<!--                            <li id="Hui-msg" class="dropDown right dropDown_hover">-->
<!--                                <a href="#" class="dropDown_A"><span id="UnreadInformation1"-->
<!--                                                                     class="badge badge-danger"></span><i-->
<!--                                        class="Hui-iconfont" style="font-size:18px">&#xe68a;</i></a>-->
<!--                                <ul class="dropDown-menu menu radius box-shadow" style="width: 380px;">-->
<!--                                    <li>-->
<!--                                        <a href="#"-->
<!--                                           style="cursor: auto; background-color: #efeded; border: 1px solid #e0e0e0;">-->
<!--                                            <span id="UnreadInformation2"-->
<!--                                                  style="display: block; text-align: center; color: dimgrey;"> 条未读信息</span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    <li>-->
<!--                                        <a href="#" id="sysMessageShow">-->
<!--                                            <i class="fas fa-envelope" style="width: 18px; padding-left: 2px;"></i> <b-->
<!--                                                id="SysInformation"></b> 条来自 <b>系统</b> 的新消息-->
<!--                                            <span id="SysInformationTime" class="f-r" style="color: dimgrey;"></span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    <li>-->
<!--                                        <a href="#" id="userMessageShow">-->
<!--                                            <i class="fas fa-users" style="width: 20px;"></i> <b-->
<!--                                                id="UserInformation"></b> 条来自 <b>用户</b> 的新信息-->
<!--                                            <span id="UserInformationTime" class="f-r" style="color: dimgrey;"></span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    <li>-->
<!--                                        <a href="#" id="flowMessageShow">-->
<!--                                            <i class="fas fa-sitemap" style="width: 20px;"></i> <b-->
<!--                                                id="FlowInformation"></b> 条来自 <b>流程图模块</b> 的新信息-->
<!--                                            <span id="FlowInformationTime" class="f-r" style="color: dimgrey;"></span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    &lt;!&ndash;							<li>&ndash;&gt;-->
<!--                                    &lt;!&ndash;								<a href="#" id="evaluateMessageShow">&ndash;&gt;-->
<!--                                    &lt;!&ndash;									<i class="fas fa-cube" style="width: 18px; padding-left: 2px;"></i> <b id="EvaluateInformation"></b> 条来自 <b>评价模块</b> 的新信息&ndash;&gt;-->
<!--                                    &lt;!&ndash;									<span id="EvaluateInformationTime" class="f-r" style="color: dimgrey;"></span>&ndash;&gt;-->
<!--                                    &lt;!&ndash;								</a>&ndash;&gt;-->
<!--                                    &lt;!&ndash;							</li>&ndash;&gt;-->
<!--                                    <li>-->
<!--                                        <a href="#" id="projectMessageShow">-->
<!--                                            <i class="fas fa-cube" style="width: 18px; padding-left: 2px;"></i> <b-->
<!--                                                id="Projectformation"></b> 条来自 <b>项目</b> 的新信息-->
<!--                                            <span id="ProjectformationTime" class="f-r" style="color: dimgrey;"></span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    <li>-->
<!--                                        <a href="#" id="mjtaskMessageShow">-->
<!--                                            <i class="fas fa-cube" style="width: 18px; padding-left: 2px;"></i> <b-->
<!--                                                id="MjTaskformation"></b> 条来自 <b>模具任务</b> 的新信息-->
<!--                                            <span id="MjTaskformationTime" class="f-r" style="color: dimgrey;"></span>-->
<!--                                        </a>-->
<!--                                    </li>-->
<!--                                    <li>-->
<!--                                        <a href="#" id="allMessageShow"><span-->
<!--                                                style="display: block; text-align: center; font-weight: 600;">查看所有信息</span></a>-->
<!--                                    </li>-->
<!--                                </ul>-->
<!--                            </li>-->
                        </ul>
                    </nav>
                </div>
            </div>
        </header>
        <aside class="Hui-aside">
            <div class="top-toolbar">
                <div class="text-left">导航菜单</div>
                <div id="topToolbarCheck" class="switch size-MINI btn-right" data-on-label="开" data-off-label="关">
                    <input type="checkbox" checked/>
                </div>
            </div>
            <div class="menu_dropdown bk_2 userMenu"></div>
        </aside>
        <div class="dislpayArrow hidden-xs">
            <a class="pngfix topToolbarCheckBtn" href="javascript:void(0);" onClick="displayNewNavbar(this)"
               style="display: none;"></a>
        </div>
        <section class="Hui-article-box">
            <div id="Hui-tabNav" class="Hui-tabNav hidden-xs">
                <div class="Hui-tabNav-wp">
                    <ul id="min_title_list" class="acrossTab cl">
                        <li>
                            <span title="我的桌面" data-href="welcome.html">我的桌面</span>
                            <em></em>
                        </li>
<!--                        <li class="active">-->
<!--                            <span title="欢迎" data-href="outside/AdaptiveDesign.html?mode=in">欢迎</span>-->
<!--                            <em></em>-->
<!--                        </li>-->
                    </ul>
                </div>
                <div class="Hui-tabNav-more-left">
                    <a id="js-tabNav-prev" class="btn" href="javascript:;">
                        <i class="fa fa-chevron-left" style="color: #999;"></i>
                    </a>
                </div>
                <div class="Hui-tabNav-more-right-group-btn">
                    <img src="/images/close-event.png" class="Hui-tabNav-more-right-img" title="关闭当前"
                         onclick="panelClossOne()"/>
                    <img src="/images/close.png" class="Hui-tabNav-more-right-img" title="关闭全部"
                         onclick="panelClossAll()"/>
                </div>
                <div class="Hui-tabNav-more-right">
                    <a id="js-tabNav-next" class="btn" style="padding: 4px 10px 4px 14px;" href="javascript:;">
                        <i class="fa fa-chevron-right" style="color: #999;"></i>
                    </a>
                </div>
            </div>
            <div id="iframe_box" class="Hui-article">
                <div class="show_iframe">
                    <div style="display:none" class="loading"></div>
                    <iframe id="iframe-welcome" data-scrolltop="0" scrolling="yes" frameborder="0"
                            src="welcome.html"></iframe>
                </div>
<!--                <div class="show_iframe">-->
<!--                    <div style="display:none" class="loading"></div>-->
<!--                    <iframe id="iframe-first-welcome" data-scrolltop="0" scrolling="yes" frameborder="0"-->
<!--                            src="outside/AdaptiveDesign.html?mode=in"></iframe>-->
<!--                </div>-->
            </div>
        </section>
<!--        <div class="my-footer">-->
<!--            <div class="container-fluid">-->
<!--                <div class="f-l">-->
<!--&lt;!&ndash;                    <a href="#" target="_blank">关于我们</a> <span class="pipe">|</span> <a href="#"target="_blank">联系我们</a>&ndash;&gt;-->
<!--&lt;!&ndash;                    <span class="pipe">|</span> <a href="#" target="_blank">法律声明</a>&ndash;&gt;-->
<!--                </div>-->
<!--                <div class="f-r">-->
<!--                    季华实验室 &nbsp;&nbsp;&nbsp;&nbsp;天津大学-->
<!--&lt;!&ndash;                    Copyright &copy;2021 Y-L.net All Rights Reserved.&ndash;&gt;-->
<!--&lt;!&ndash;                    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow">津ICP备0000000号</a><br>&ndash;&gt;-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <div class="my-footer">
            <div class="container-fluid">
                <div class="f-r"><div  id="footer"></div></div>
            </div>
        </div>
        <div class="contextMenu" id="Huiadminmenu">
            <ul>
                <li id="closethis">关闭当前</li>
                <li id="closeall">关闭全部</li>
            </ul>
        </div>
        <script type="text/javascript" src="/nui-ad/lib/jquery.contextmenu/jquery.contextmenu.r2.js"></script>
        <script type="text/javascript">
            // 初始化参数
            document.title = WEB_TITLE;
            document.getElementById("logo-title").innerHTML = WEB_TITLE;
            document.getElementById("logo-title-mini").innerHTML = WEB_TITLE_MINI;
            document.getElementById("footer").innerHTML = FOOTER_TEXT;
            // 用户信息
            var SignUserInfo;

            // 用户信息
            var accessInfo;
            // 获取用户信息
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: '/s/entry/showUserInfo',
                async: false,
                success: function (data) {
                    if (data.result == "success") {
                        SignUserInfo = data.user;
                        $('#sys_login_name').html(data.user.f_name);
                    }else{
                        top.location.href = '/module/go.html';
                    }
                },
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
            //获取用户名密码
            //alert(SignUserInfo.f_login);
            //alert( SignUserInfo.f_pass);
            // 业务代码
            $(function () {
                // 获取权限菜单
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    url: '/s/role/powerTree',
                    async: false,
                    success: function (data) {
                        if (data.result == "success") {
                            var menu = data.menu;
                            for (var i = 0; i < menu.length; i++) {
                                var item = menu[i];
                                // 子菜单
                                var childMenu = '';
                                var children = item.children;
                                if (children) {
                                    for (var j = 0; j < children.length; j++) {
                                        var element = children[j];
                                        childMenu += '<li>' +
                                            '<a id = "'+element.no+'" data-href="' + element.url+ '&FMenID='+element.key + '" data-title="' + element.title + '" href="javascript:void(0)" onclick="return checkCondition(\'' + element.no + '\',\'' + element.key + '\');"> ' +
                                            '<i class="fa fa-circle" style="width: 20px;"></i>' + element.title +
                                            '</a>' +
                                            '</li>';
                                    }
                                }
                                // 主菜单
                                $('.userMenu').append(
                                    '<dl>' +
                                    '<dt>' +
                                    '<i class="fas ' + item.icon + '" style="width: 20px; font-size: 15px; color: #516e82;"></i>' +
                                    ' <span style="font-size: 1.04em;">' + item.title + '</span>' +
                                    '<i class="Hui-iconfont menu_dropdown-arrow">&#xe6d5;</i>' +
                                    '</dt>' +
                                    '<dd><ul>' + childMenu + '</ul></dd>' +
                                    '</dl>'
                                );

                            }
                            // 左侧菜单渲染
                            $(".Hui-aside").Huifold({
                                titCell: '.menu_dropdown dl dt',
                                mainCell: '.menu_dropdown dl dd'
                            });
                        }
                    },
                    error: function (e) {
                        console.log(e.status);
                        console.log(e.responseText);
                    }
                });
                // 获取未读计数
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    url: '/s/message/queryUnreadNum', // 调用地址
                    async: false,
                    success: function (data) {
                        if (data.result == 'success') {
                            if (data['AllNum'] == 0) {
                                $('#UnreadInformation1').html('');
                            } else {
                                $('#UnreadInformation1').html(data['AllNum']);
                            }
                            $('#UnreadInformation2').html(data['AllNum'] + ' 条未读信息');
                            $('#SysInformation').html(data['SysNum']);
                            $('#SysInformationTime').html(data['SysNumStr']);
                            $('#UserInformation').html(data['UserNum']);
                            $('#UserInformationTime').html(data['UserNumStr']);
                            $('#FlowInformation').html(data['FlowNum']);
                            $('#FlowInformationTime').html(data['FlowNumStr']);
                            // $('#EvaluateInformation').html(data['EvaluateNum']);
                            // $('#EvaluateInformationTime').html(data['EvaluateNumStr']);
							$('#Projectformation').html(data['ProjectNum']);
							$('#ProjectformationTime').html(data['ProjectNumStr']);
							$('#MjTaskformation').html(data['MjTaskNum']);
							$('#MjTaskformationTime').html(data['MjTaskNumStr']);


                        } else if (data.result == 'error') {
                            toastr.error(data.error);
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
                // 菜单顶部折叠按钮事件
                $('#topToolbarCheck').on('switch-change', function (e, data) {
                    var value = data.value;
                    if (value) {
                        $('body').removeClass('big-page');
                    } else {
                        $('body').addClass('big-page');
                        $('.topToolbarCheckBtn').show();
                        $('.topToolbarCheckBtn').addClass('open');
                    }
                });
                // 用户基本信息修改-菜单点击事件
                $('#userInfoEdit').on('click', function () {
                    layer_show('修改个人信息', '/module/sys/userInfo.html', '', '400');
                });
                // 密码修改-菜单点击事件
                $('#passwordEdit').on('click', function () {
                    layer_show('修改密码', '/module/sys/userPW.html', '460', '280');
                });
                // 用户退出登录-菜单点击事件
                $('#logOut').on('click', function () {
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/entry/loginOut',
                        async: false,
                        success: function (data) {
                            localStorage.setItem('simulation_dmsnid', '');
                            window.location.href = '/module/login.html';
                        },
                        error: function (e) {
                            toastr.error(e.status);
                            toastr.error(e.responseText);
                        }
                    });
                });
                // 消息-菜单点击事件
                $('#sysMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=1', '1000', '550');
                });
                $('#userMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=2', '1000', '550');
                });
                $('#flowMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=3', '1000', '550');
                });
                // $('#evaluateMessageShow').on('click', function(){
                //   layer_show('消息','/module/sys/message.html?type=4','1000','550');
                // });

                $('#projectMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=5', '1000', '550');
                });
                $('#mjtaskMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=6', '1000', '550');
                });


                $('#allMessageShow').on('click', function () {
                    layer_show('消息', '/module/sys/message.html?type=-1', '1000', '550');
                });
            });

            // 左侧菜单-隐藏显示
            function displayNewNavbar(obj) {
                if ($(obj).hasClass('open')) {
                    $(obj).hide();
                    $(obj).removeClass('open');
                    $('body').removeClass('big-page');
                    $('#topToolbarCheck').bootstrapSwitch('setState', true);
                } else {
                    $(obj).show();
                    $(obj).addClass('open');
                    $('body').addClass('big-page');
                }
            }

            function checkCondition(fno,fkeyid){
                // // 获取用户信息
                // $.ajax({
                //     type: 'POST',
                //     contentType: 'application/json',
                //     url: '/s/tpermissionGroup/queryaccesscontrol',
                //     data: JSON.stringify({
                //         FMenID: fkeyid,
                //     }),
                //     async: false,
                //     success: function (data) {
                //         if (data.result == "success") {
                //             accessInfo = data.accessInfo;
                //             return true;
                //         }else{
                //             var newHref = "/module/access404.html";
                //             document.getElementById(fno).setAttribute('data-href', newHref);
                //             return true; // 允许跳转
                //         }
                //     },
                //     error: function (e) {
                //         console.log(e.status);
                //         console.log(e.responseText);
                //     }
                // });
                // if(!accessInfo){
                //     var newHref = "/module/access404.html";
                //     document.getElementById(fno).setAttribute('data-href', newHref);
                //     return true; // 允许跳转
                // }
                // return true; // 允许跳转
            }

            // 功能选项卡全部关闭
            function panelClossOne() {
                $('#min_title_list').find('li.active i').trigger("click");
            }

            function panelClossAll() {
                layer.confirm('确定要关闭所有选项卡吗?', function (index) {
                    $('#min_title_list').find('li i').trigger("click");
                    layer.close(layer.index);
                });
            }
        </script>
    </body>
</html>
<!-- 会话代码 开始 -->
<script type="text/javascript">
    var MessageWebsocket = null;
    // 建立WebSocket连接
    reconnectSocket('ws://' + SERVERURL + '/message/' + SignUserInfo.f_login);
    // 监听窗口关闭事件，当窗口关闭时，主动去关闭MessageWebsocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function () {
        MessageWebsocket.close();
    }
    // 连接发生错误的回调方法
    MessageWebsocket.onerror = function () {
        console.log('The MessageWebsocket is error');
    };
    //连接成功建立的回调方法
    MessageWebsocket.onopen = function (event) {
        console.log('The MessageWebsocket is open');
    }
    // 连接关闭的回调方法
    MessageWebsocket.onclose = function () {
        console.log('The MessageWebsocket is close');
        onLineCheck(); // 断开链接时调用网络中断监测
    }
    // 接收到消息的回调方法
    MessageWebsocket.onmessage = function (event) {
        var data = JSON.parse(event.data);
        // 更新未读数量
        if ($('#UnreadInformation1').html() == '') {
            $('#UnreadInformation1').html('<span id="UnreadInformation1Span" class="badge badge-warning navbar-badge">1</span>');
            $('#UnreadInformation2').html('1 条未读信息');
        } else {
            var num = parseInt($('#UnreadInformation1Span').html()) + 1;
            $('#UnreadInformation1').html('<span id="UnreadInformation1Span" class="badge badge-warning navbar-badge">' + num + '</span>');
            $('#UnreadInformation2').html(num + ' 条未读信息');
        }
        switch (data.type) {
            case 1: // 系统
                $('#SysInformation').html(parseInt($('#SysInformation').html()) + 1);
                $('#SysInformationTime').html('现在');
                break;

            case 2: // 用户
                $('#UserInformation').html(parseInt($('#UserInformation').html()) + 1);
                $('#UserInformationTime').html('现在');
                break;

            case 3: // 流程图
                $('#FlowInformation').html(parseInt($('#FlowInformation').html()) + 1);
                $('#FlowInformationTime').html('现在');
                break;

            // case 4: // 评价
            //   $('#EvaluateInformation').html(parseInt($('#EvaluateInformation').html())+1);
            //   $('#EvaluateInformationTime').html('现在');
            //   break;
            case 5: // 评价
                $('#Projectformation').html(parseInt($('#Projectformation').html()) + 1);
                $('#ProjectformationTime').html('现在');
                break;
            case 6: // 评价
                $('#MjTaskformation').html(parseInt($('#MjTaskformation').html()) + 1);
                $('#MjTaskformationTime').html('现在');
                break;

            default:
                break;
        }
        // 向用户发消息
        $(document).Toasts('create', {
            body: data.message,
            title: '您有新短消息，请注意查收',
            icon: 'fas fa-envelope fa-lg',
        })
    }

    // 建立连接
    function reconnectSocket(url) {
        if ('WebSocket' in window) {
            MessageWebsocket = new ReconnectingWebSocket(url);
        } else if ('MozWebSocket' in window) {
            MessageWebsocket = new MozWebSocket(url);
        } else {
            MessageWebsocket = new SockJS(url);
        }
    }

    // 关闭连接
    function closeWebSocket() {
        MessageWebsocket.close();
    }

    // 发送消息
    function send() {
        var message = document.getElementById('text').value;
        MessageWebsocket.send(message);
    }

    // 断网监测支持
    function onLineCheck() {
        Offline.check();
        console.log(Offline.state, '---Offline.state');
        console.log(this.socketStatus, '---this.socketStatus');
        if (!this.socketStatus) {
            console.log('网络连接已断开！');
            if (Offline.state === 'up' && websocket.reconnectAttempts > websocket.maxReconnectInterval) {
                window.location.reload();
            }
            reconnectSocket('ws://' + SERVERURL + '/message/' + SignUserInfo.f_login);
        } else {
            console.log('网络连接成功！');
            websocket.send("heartBeat");
        }
    }
</script>
<!-- 会话代码 结束 -->