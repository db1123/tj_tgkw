<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="renderer" content="webkit|ie-comp|ie-stand">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport"
              content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
        <meta http-equiv="Cache-Control" content="no-siteapp"/>
        <!--_global 公共配置文件 -->
        <script language="javascript">var golbal_type = "admin";</script>
        <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
        <!--_only 独立样式 -->
        <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
        <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
        <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
        <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
        <link href="/module/network/css/relationgtree.css" rel="stylesheet">
        <!--/_only 独立样式 -->
        <style type="text/css">

            .ztree div.diy {
                height: 100%;
                width: 100%;
                line-height: 30px;
                border-top: 1px dotted #ccc;
                border-left: 1px solid #eeeeee;
                text-align: center;
                display: inline-block;
                box-sizing: border-box;
                color: #6c6c6c;
                font-family: "SimSun";
                font-size: 12px;
                overflow: hidden;
            }

        </style>
    </head>
    <body>
        <div class="page-container" style="padding: 2px;">
            <div class="f-l" style="width: 100%; margin-top: 3px;">
                <div class="row">
                    <div class="col-md-6 col-sm-5 col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-header">项目产品结构</div>
                            <div class="panel-body">
                                <div class="col-12">
                                    <select name="xmselect" class="form-control" id="xmselect"
                                            style="width: 330px;"></select>
                                </div>
                                <div class="col-12 form-control-div">
                                    <div id="tableMain">
                                        <ul id="dataTree" class="ztree">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-7 col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-header"><strong id="bomname"></strong>相关文件</div>
                            <div class="panel-body">
                                <table id="mainTable" class="display compact" style="width: 99.8%;"></table>
                                <a id="downloada" download="" href="" target="_blank" style="display: none"><span id="downloadspan">下载文件</span></a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
        <script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
        <script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
        <script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
        <script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
        <script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
        <script src="/plugins/select2/js/select2.full.min.js"></script>
        <script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
        <script src="/javascript/zTree/js/jquery.ztree.exhide.js"></script>
        <script type="text/javascript">
            var data;
            var bommid;
            var xmselect;
            var fmid=0;
            var xmid =0;
            //根据选择的项目 查询数据 赋值 data
            $(function () {

                // 初始维度配置化
                xmselect = $("#xmselect").select2({
                    placeholder: '请选择项目',
                    ajax: {
                        type: 'POST',
                        url: "/s/myproject/queryDatamyprojectSelectbom",
                        dataType: 'json',
                        data: function (params) {
                            return {
                                search: params.term
                            };
                        },
                        processResults: function (data) {
                            return {
                                results: data.list
                            };
                        },
                        delay: 800,
                        cache: true
                    },
                    language: "zh-CN"
                });

                $('#mainTable').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/subdata/queryttaskjfw', // 调用地址
                        data: function ( d ) {
                            return JSON.stringify( $.extend( {}, d, {
                                page: d.start/d.length+1, // 当前页
                                results: d.length, // 每页显示条数
                                fmid: fmid,//物料ID
                                xmid:xmid
                            } ) );
                        },
                        dataSrc: function (json) {
                            json.recordsFiltered = json.total;  // 总行数
                            json.recordsTotal = json.page; // 当前页数
                            return json.list;
                        },
                        error: function (xhr, status, error) {
                            toastr.error(xhr);
                        }
                    },
                    columns: [
                        { title: '交付物名称', data: 'FName'},
                        { title: '文件名称', data: 'FFileName'},
                        { title: '文件类型', data: 'FTypeName'},
                        { title: '是否交付', data: 'FStateName'},
                        { title: '版本', data: 'FEdition'},
                        {
                            title: '浏览',
                            data: 'FState',
                            width: 150,
                            orderable: false,
                            render: function (data, type, row) {
                                var yl = '';
                                var xz = '';
                                var xq ='';
                                var sb='';
                                if (row.FState == 1) {

                                    if (row.isFFileType == 0) {
                                        yl = '<button  class="btn btn-default  size-MINI " onclick="yulan(\'' + row.key + '\')"><i class="fa fa-eye" aria-hidden="true"></i>预览</button>&nbsp;';
                                    } else {
                                        //yl = '<button  class="btn btn-default  size-MINI " ><a id="yulana" href="openIE:'+YULANIP+'/plugins/yulan/index.html?id=\'' + row.key + '\'"><i class="fa fa-eye" aria-hidden="true"></i>预览</a></button>&nbsp;';
                                        yl='';
                                    }
                                    xz = '<button  class="btn btn-default  size-MINI " onclick="xiazai(\'' + row.key + '\')"><i class="fa fa-download" aria-hidden="true"></i>下载</button>&nbsp;';

                                }
                                else {
                                    yl = '<button  class="btn btn-default  size-MINI disabled" ><i class="fa fa-eye" aria-hidden="true"></i>预览</button>&nbsp;';
                                    xz = '<button  class="btn btn-default  size-MINI disabled" ><i class="fa fa-download" aria-hidden="true"></i>下载</button>&nbsp;';
                                }
                                return xq + yl + xz ;

                            }
                        }
                    ],
                    scrollY: (document.body.clientHeight-100) + 'px',
                    scrollX: true,
                    paging: true, // 是否开启本地分页
                    pageLength: 15, // 改变初始化页长度（每页多少条数据）
                    pagingType: 'full_numbers', // 首页，尾页，上一页和下一页四个按钮,加上数字按钮
                    lengthChange: false, // 是否允许因子改变表格每页显示的记录数
                    searching: false, // 是否允许Datatables开启本地搜索
                    ordering: true, // 是否允许Datatables开启排序
                    info: true, // 控制是否显示表格左下角的信息
                    language: DataTablesLanguage
                });


            });

            function xiazai(fkey) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/subdata/getmytaskSubdataUrl',
                    data: JSON.stringify({
                        id: fkey,
                        ip: YULANIP,
                        ftype: 2,
                        classifytype:2,
                        executetype:2,
                        // FProjectID: 0,
                        // FTaskID: 0
                    }),
                    success: function (data) {
                        if (data.result == 'success') {
                            $("body").mLoading("show");
                            setTimeout(function () {
                                $('.mloading-text').html('正在获取文件信息...');
                                $("#downloada").attr('download', data.filename);
                                $("#downloada").attr('href', data.url);
                                setTimeout(function () {
                                    $('.mloading-text').html('获取完成准备下载...');
                                    $("#downloadspan").trigger("click");
                                    setTimeout(function () {
                                        $('#mainTable').DataTable().ajax.reload(null, false);
                                        $("body").mLoading("hide");
                                    }, 1000);
                                }, 1000);
                            }, 1000);

                        }
                        if (data.result == 'error') {
                            toastr.error(data.error);
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }
        </script>

        <script type="text/javascript">
            function addDiyDom(treeId, treeNode) {
                var spaceWidth = 15;
                var liObj = $("#" + treeNode.tId);
                var aObj = $("#" + treeNode.tId + "_a");
                var switchObj = $("#" + treeNode.tId + "_switch");
                var icoObj = $("#" + treeNode.tId + "_ico");
                var spanObj = $("#" + treeNode.tId + "_span");
                aObj.attr('title', '');
                aObj.append('<div class="diy swich" onclick="chakan(\'' + treeNode.id + '\',\'' + treeNode.name + '\')"></div>');
                var div = $(liObj).find('div').eq(0);
                switchObj.remove();
                spanObj.remove();
                icoObj.remove();
                div.append(switchObj);
                div.append(spanObj);
                var spaceStr = "<span style='height:1px;display: inline-block;width:" + (spaceWidth * treeNode.level) + "px'></span>";
                switchObj.before(spaceStr);
                var editStr = '';
                // editStr += '<div class="diy">' + (treeNode.ftype == '-' ? '<div class="icon_div"></div>' : treeNode.ftype) + '</div>';

                // editStr += '<div class="diy">' + formatHandle(treeNode) + '</div>';
                aObj.append(editStr);
            }

            /**
             * 查询数据
             */
            function query(fkeyid) {
                $("body").mLoading("show");
                setTimeout(function () {
                    $('.mloading-text').html('正在查询中...');
                    $.ajax({
                        url: '/s/myproject/showBomTableTreeProjectsy', // 调用地址
                        contentType: 'application/json',
                        data: JSON.stringify({
                            FProjectID:  fkeyid
                        }),
                        type: 'post',
                        traditional: true,
                        success: function (data) {
                            bommid = data.bommid;
                            setTimeout(function () {
                                $('.mloading-text').html('构建数据中...');
                                setTimeout(function () {
                                    setTimeout(function () {
                                        $('.mloading-text').html('查询完成...');
                                        $("body").mLoading("hide");
                                        setTimeout(function () {
                                            //!*************************初始化方案树*********************************
                                            var setting = {
                                                view: {
                                                    showLine: false,
                                                    showIcon: false,
                                                    addDiyDom: addDiyDom
                                                },

                                                data: {
                                                    simpleData: {
                                                        enable: true,
                                                        idKey: "id",
                                                        pIdKey: "pId",
                                                        rootPId: 0
                                                    }
                                                }

                                            };
                                            var zNodes = eval(data.json);
                                            $(document).ready(function () {
                                                var treeObj = $.fn.zTree.init($("#dataTree"), setting, zNodes);
                                                treeObj.expandAll(true);

                                                //添加表头
                                                var li_head = ' <li class="head"><a><div class="diy">编号/名称</div>';//<div class="diy">类型</div><div class="diys">操作</div>
                                                var rows = $("#dataTree").find('li');
                                                if (rows.length > 0) {
                                                    rows.eq(0).before(li_head)
                                                } else {
                                                    $("#dataTree").append(li_head);
                                                    $("#dataTree").append('<li ><div style="text-align: center;line-height: 30px;" >无符合条件数据</div></li>')
                                                }
                                            });
                                            $("body").mLoading("hide");
                                        }, 1000);

                                    }, 2000);
                                }, 1000);
                            }, 1000);


                        }
                    });
                }, 1000);

            }

            /**
             * 根据权限展示功能按钮
             * @param treeNode
             * @returns {string}
             */
            function formatHandle(treeNode) {
                var htmlStr = '';
                if (treeNode.id != bommid) {
                    htmlStr = '<div class="icon_div"><button type="button" style="z-index:9999" class="btn btn-secondary size-MINI" onclick="SaveGx(\'' + treeNode.id + '\',\'' + treeNode.name + '\')"><i class="fas fa-edit"></i> 设置关系</button></div>';
                } else {
                    htmlStr = '<div class="icon_div"></div>';
                }
                return htmlStr;

            }

            function chakan(fkeyid,name){
                fmid = fkeyid;
                $("#bomname").text(name);
                $('#mainTable').DataTable().ajax.reload(null, false);
            }


            $(function () {
                var li_head = ' <li class="head"><a><div class="diy">编号/名称</div>';//<div class="diy">类型</div><div class="diys">操作</div>
                $("#dataTree").append(li_head);
                $("#dataTree").append('<li ><div style="text-align: center;line-height: 30px;" >无符合条件数据</div></li>');
                $("#bomname").text('');
                //初始化数据
                $('#xmselect').change(function () {
                    xmid = $('#xmselect').val();
                    query(xmid);
                });

            });
        </script>

    </body>
</html>