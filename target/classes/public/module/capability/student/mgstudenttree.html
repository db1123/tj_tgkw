<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <!--_only 独立样式 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
    <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/demo.css" type="text/css">
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/metroStyle/metroStyle.css" type="text/css">
    <!--/_only 独立样式 -->
</head>
<style type="text/css">
    ul.ztree {
        /*margin-left: 20px;*/
        border: 1px solid #617775;
        background: #f0f6e4;
        width: 31vw;
        height: 83vh;
        overflow-y: scroll;
        overflow-x: auto;
    }
    /* 自定义图标样式 */
    .ztree li a span[class*="_ico_open"],
    .ztree li a span[class*="_ico_close"],
    .ztree li a span[class*="_ico_docu"]{
        background-size: 18px 18px; /* 背景图片的大小 */
        width: 18px;
        height: 18px;
    }

    .ztree li a span.school-icon_ico_open,
    .ztree li a span.school-icon_ico_close {
        background-image: url("images/school.png") !important;
    }

    .ztree li a span.college-icon_ico_open,
    .ztree li a span.college-icon_ico_close,
    .ztree li a span.college-icon_ico_docu{
        background-image: url("images/mti_hy.png") !important;
    }

    .ztree li a span.major-icon_ico_open,
    .ztree li a span.major-icon_ico_close,
    .ztree li a span.major-icon_ico_docu{
        background-image: url("images/mti_qz.png") !important;
    }

    .ztree li a span.class-icon_ico_docu{
        background-image: url("images/mti_class.png") !important;
    }

    .ztree li a span[class*="_bt"]{
        background-size: 16px 16px; /* 调整图标大小 */
        width: 16px;
        height: 16px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 5px; /* 调整按钮与文本的间距 */
        cursor: pointer; /* 设置鼠标指针为手型 */
    }
    /* 定义编辑按钮图标样式 */
    .ztree li a span.studentadd-button_bt,
    #addstudent{
        background-image: url("images/mti_add.png") !important;
    }
</style>
<body>
<div class="page-container">
    <div class="f-l " style="width: 98.8%; padding-top: 1px;">
        <div class="row cl">
            <div class="col-md-4">
                <div class="card-body">
                    <div class="zTreeDemoBackground left">
                        <input type="text" id="key" value="" class="empty input-text" placeholder="请输入关键字" style="width: 480px;"/><br/>
                        <ul id="treeDemo" class="ztree"></ul>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card-body" style="margin-top: 0px;">
                    <div class="panel panel-default">
                        <div class="panel-header"><strong class="typename">已选专业：无</strong></div>
                        <div class="panel-body">
<!--                            <div class="f-l text-l" id="newadd" style="display: none;">-->
<!--                                <button type="button" class="btn btn-default size-S my-btn"-->
<!--                                        onclick="adduser()">-->
<!--                                    <i class=" fa fa-user-plus"></i>-->
<!--                                    添加学生-->
<!--                                </button>-->
<!--                            </div>-->
                            <div class="f-r text-r">
                                <div class="f-l text-l">
                                    <input type="text" class="input-text size-S form-text-FNo" style="width:160px"
                                           placeholder="学生学号">
                                    <input type="text" class="input-text size-S form-text-FName" style="width:160px"
                                           placeholder="学生姓名">
                                    <input type="text" class="input-text size-S form-text-FTel" style="width:160px"
                                           placeholder="联系电话">
                                    <select id="FSex" name="FSex" style="width: 60px;"></select>
                                </div>
                                <button type="button" class="btn btn-default size-S my-btn btn-search-fun"><i
                                        class="Hui-iconfont">&#xe665;</i>
                                    搜索
                                </button>
                            </div>
                            <table id="mainTable" class="display compact" style="width: 99.8%; margin-top: 5px;"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/fuzzysearch.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    var xfno;
    var showtype = getQueryStringByName('showtype');
    var projectid = getQueryStringByName('id');//项目ID
    var zNodes = [];
    var treesetting = {};
    var treeObj = null;
    var ftypeid = -1;
    var ftypename = "";
    var pfstate = -1;


    var filename = "";//文件名称
    var feditionNo = 1;//当前版本


    var xmname;

    var parentId;
    var parentName;
    // 保存搜索关键字
    let searchKeyword = '';

    var table;
    // 业务代码
    $(function () {

        $("#FSex").select2({
            placeholder: '请选择性别',
            data: [{id: "-1", text: "全部"}, {id: 0, text: "男"}, {id: 1, text: "女"}],
            language: "zh-CN"
        });
        // $("#newadd").attr("style", "display:none;"); //隐藏

        // $("#downloada").hide();


        // if (pfstate == 1 && showtype == 2) {
        //     if (ftypeid != -1 && projectid) {
        //         $("#newadd").attr("style", "display:block;"); //显示
        //     } else {
        //         $("#newadd").attr("style", "display:none;"); //隐藏
        //     }
        //
        // } else {
        //     $("#newadd").attr("style", "display:none;"); //隐藏
        // }

        treesetting = {
            view: {
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
                selectedMulti: false,
                showIcon: true // 显示图标
            },
            check: {
                enable: false
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: false
            },
            callback: {
                onClick: zTreeOnClick
            }
        };
        gettreedata(1);
        $('#key').on('input', function() {
            searchKeyword =  $(this).val();
        });
        // 封装表格
        table = $('#mainTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                type: 'POST',
                contentType: 'application/json',
                url: '/s/major/queryclassstudent', // 调用地址
                data: function (d) {
                    return JSON.stringify($.extend({}, d, {
                        page: d.start / d.length + 1, // 当前页
                        results: d.length, // 每页显示条数
                        dataall: 1,
                        name: $('.form-text-FName').val(),//学生名称
                        fno: $('.form-text-FNo').val(),//学生学号
                        ftel: $('.form-text-FTel').val(),//联系电话
                        fsex: $('#FSex').val(),//性别
                        classstudentid: ftypeid
                    }));
                },
                dataSrc: function (json) {
                    json.recordsFiltered = json.total;  // 总行数
                    json.recordsTotal = json.page; // 当前页数
                    return json.list;
                },
                error: function (xhr, status, error) {
                    toastr.error(xhr);
                }
            },
            columns: [
                {title: '学生学号', data: 'FNo'},
                {title: '学生姓名', data: 'FName'},
                {
                    title: '性别', data: 'FSex',
                    render: function (data, type, row) {
                        if (data == -1) {
                            return "保密";
                        } else if (data == 0) {
                            return "男";
                        } else if (data == 1) {
                            return "女";
                        }
                    }
                },
                {title: '出生日期', data: 'FBirthday'},
                {title: '联系电话', data: 'FTel'},

                {
                    title: '操作',
                    data: 'FState',
                    width: 180,
                    orderable: false,
                    render: function (data, type, row) {
                        var yc = '<button type="button" class="btn btn-danger size-MINI" onclick="delcalssstudent(\'' + row.key + '\',\'' + row.FName + '\')"><i class="fas fa-edit"></i>移除</button> ';
                        var hx = '<button type="button" class="btn btn-secondary size-MINI" onclick="huaxiang(\'' + row.FStudentID + '\')"><i class="fas fa-edit"></i>能力画像</button>';
                        return hx + yc;
                    }
                }
            ],
            // scrollY: (document.body.clientHeight -220) + 'px',
            scrollY: 66+ 'vh',
            scrollX: true,
            paging: true, // 是否开启本地分页
            pageLength: 20, // 改变初始化页长度（每页多少条数据）
            pagingType: 'full_numbers', // 首页，尾页，上一页和下一页四个按钮,加上数字按钮
            lengthChange: false, // 是否允许因子改变表格每页显示的记录数
            searching: false, // 是否允许Datatables开启本地搜索
            ordering: true, // 是否允许Datatables开启排序
            info: true, // 控制是否显示表格左下角的信息
            language: DataTablesLanguage
        });

// 查询按钮点击事件
        $('.btn-search-fun').on('click', function () {
            $('#mainTable').DataTable().ajax.reload(null, false);
        });

    });

    function huaxiang(fkeyid) {
        layer_show('学生能力画像', '/module/capability/student/huaxiang/studentabilityhx3.html?userid=' + fkeyid + '&ftype=2', '', '');
    }

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        //专业
        if (treeNode.ftype == 1) {
            if ($("#addBtn_" + treeNode.tId).length > 0) return
            if ($("#upBtn_" + treeNode.tId).length > 0) return;
            if ($("#delBtn_" + treeNode.tId).length > 0) return;
            var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                + "' title='新增班级信息' onfocus='this.blur();'></span>" +
                "<span class='button edit' id='upBtn_" + treeNode.tId
                + "' title='修改专业名称''></span>"
            ;
            sObj.after(addStr);
            var btn = $("#addBtn_" + treeNode.tId);
            if (btn) btn.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选专业：" + xmname);
                //新增专业下的年级与班级
                var index = layer.open({
                    type: 2,
                    area: ['800px', '400px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '新增班级信息',
                    content: '/module/capability/student/classstudent/classstudentedit.html?id=' + treeNode.id+'&op=1'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });
            var btn2 = $("#upBtn_" + treeNode.tId);
            if (btn2) btn2.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选专业：" + xmname);
                //修改专业信息
                var index = layer.open({
                    type: 2,
                    area: ['800px', '400px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '修改专业名称',
                    content: '/module/capability/student/base/majoredit.html?id=' + treeNode.id+'&op=2'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });

        } else if (treeNode.ftype == 3) { //班级
            if ($("#addBtn2_" + treeNode.tId).length > 0) return;
            if ($("#upBtn2_" + treeNode.tId).length > 0) return;
            if ($("#delBtn2_" + treeNode.tId).length > 0) return;
            var addStr2="<span class='button studentadd-button_bt' id='addBtn2_" + treeNode.tId
                + "' title='添加学生' onfocus='this.blur();'></span>";
            var upStr2 = "<span class='button edit' id='upBtn2_" + treeNode.tId
                + "' title='修改班级信息''></span>";
            var remove2 = "<span class='button remove' id='delBtn2_" + treeNode.tId
                + "' title='删除班级及学生''></span>";
            sObj.after(remove2);
            sObj.after(upStr2);
            sObj.after(addStr2);
            var btn = $("#addBtn2_" + treeNode.tId);
            if (btn) btn.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选班级：" + xmname);
                var index = layer.open({
                    type: 2,
                    area: ['800px', '400px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '添加学生信息',
                    content: '/module/capability/student/classstudent/classstudentedit4.html?id=' + treeNode.id+'&op=2'
                    // , end: function () {
                    //     gettreedata(2);
                    // }
                });
                return false;
            });
            var btn2 = $("#upBtn2_" + treeNode.tId);
            if (btn2) btn2.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;

                $(".typename").text("已选班级：" + xmname);
                var parentNode = treeNode.getParentNode();
                if (parentNode) {
                    // 获取父节点的 id 和 name
                    parentId = parentNode.id;
                    parentName = parentNode.name;
                }
                //修改班级信息
                var index = layer.open({
                    type: 2,
                    area: ['800px', '400px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '修改班级信息',
                    content: '/module/capability/student/classstudent/classstudentedit2.html?id=' + treeNode.id+'&op=2&FMajorID=' + parentId
                    , end: function () {
                        gettreedata(2);
                    }
                });
                return false;
            });
            var btn3 = $("#delBtn2_" + treeNode.tId);
            if (btn3) btn3.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选班级：" + xmname);
                //删除年级与班级信息及学生信息
                delcalsssandtudent(treeNode.id,rename(treeNode.name));
                ftypeid = -1;
                return false;
            });
        }else if (treeNode.ftype == 0) {//学院

            if ($("#upBtn3_" + treeNode.tId).length > 0) return;
            if ($("#addBtn3_" + treeNode.tId).length > 0) return;
            var addStr2="<span class='button add' id='addBtn3_" + treeNode.tId
                + "' title='新增专业' onfocus='this.blur();'></span>";
            var upStr2 = "<span class='button edit' id='upBtn3_" + treeNode.tId
                + "' title='修改学院名称''></span>";


            sObj.after(upStr2);
            sObj.after(addStr2);
            var btn = $("#addBtn3_" + treeNode.tId);
            if (btn) btn.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选学院：" + xmname);

                var index = layer.open({
                    type: 2,
                    area: ['800px', '400px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '新增专业信息',
                    content: '/module/capability/student/base/majoredit.html?id=' + treeNode.id+'&op=1'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });
            var btn2 = $("#upBtn3_" + treeNode.tId);
            if (btn2) btn2.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选学院：" + xmname);

                //修改学院名称
                var index = layer.open({
                    type: 2,
                    area: ['600px', '200px'], // 设置宽高
                    fix: false, //不固定
                    shade: 0.4,
                    title: '修改学院名称',
                    content: '/module/capability/student/base/collegeedit.html?id=' + treeNode.id+'&op=2'
                    , end: function () {
                        gettreedata(2);

                    }
                });
                return false;
            });

        }
    }

    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();
        $("#upBtn_" + treeNode.tId).unbind().remove();

        $("#addBtn2_" + treeNode.tId).unbind().remove();
        $("#upBtn2_" + treeNode.tId).unbind().remove();
        $("#delBtn2_" + treeNode.tId).unbind().remove();

        $("#addBtn3_" + treeNode.tId).unbind().remove();
        $("#upBtn3_" + treeNode.tId).unbind().remove();
    }

    function gettreedata(type) {
        $.ajax({
            type: 'POST',
            contentType: 'application/json;charset=UTF-8',
            url: '/s/major/quermajortree',
            data: JSON.stringify({
                FSchool: FSchooltree
            }),
            success: function (data) {
                if (data.result == 'success') {
                    zNodes = data.zNodes;
                    if(type == 1){
                        treeObj = $.fn.zTree.init($("#treeDemo"), treesetting, zNodes);
                        fuzzySearch('treeDemo','#key',null,true); //初始化模糊搜索方法
                    }
                    else if(type == 2){
                        updateTree(zNodes);
                        $("#key").val("");
                        // 如果关键字存在，重新触发搜索
                        if (searchKeyword) {
                            $("#key").val(searchKeyword); // 设置关键字到输入框
                            fuzzySearch('treeDemo','#key',null,true,2); //初始化模糊搜索方法
                        }
                    }


                    // treeObj.expandAll(true);
                    // var nodes = treeObj.getSelectedNodes();
                    //
                    // if (nodes.length > 0) {
                    //     for (var i = 0; i < nodes.length; i++) {
                    //         treeObj.expandNode(nodes[i], true, true, true);
                    //     }
                    // }
                }
            },
            error: function (e) {
                toastr.error(e.status);
                toastr.error(e.responseText);
            }
        });
    }

    // 更新 zTree 数据
    function updateTree(newNodes) {
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");

        // 获取当前选中的节点
        var selectedNodes = treeObj.getSelectedNodes();
        var selectedNodeId = selectedNodes.length > 0 ? selectedNodes[0].id : null;

        // 获取当前展开的节点
        var expandedNodes = [];
        var allNodes = treeObj.transformToArray(treeObj.getNodes());
        allNodes.forEach(function (node) {
            if (node.open) {
                expandedNodes.push(node.id);
            }
        });

        // 清空当前树
        treeObj.destroy();

        // 重新初始化 zTree
        treeObj = $.fn.zTree.init($("#treeDemo"), treesetting, newNodes);

        // 恢复展开状态
        expandedNodes.forEach(function (id) {
            var node = treeObj.getNodeByParam("id", id);
            if (node) {
                treeObj.expandNode(node, true, false, false);
            }
        });

        // 恢复选中状态
        if (selectedNodeId) {
            var selectedNode = treeObj.getNodeByParam("id", selectedNodeId);
            if (selectedNode) {
                treeObj.selectNode(selectedNode);
            }
        }
    }

    function zTreeOnClick(event, treeId, treeNode) {

        if(treeNode.ftype ==1){
            $(".typename").text("已选专业：" + rename(treeNode.name));
            // var newHeight = (document.body.clientHeight - 220) + 'px'; // 示例：改变高度计算
            // table.settings()[0].oScroll.sY = newHeight;
            // table.draw();
        }else if(treeNode.ftype ==3){
            $(".typename").text("已选班级：" + rename(treeNode.name));
            // var newHeight = (document.body.clientHeight - 0) + 'px'; // 示例：改变高度计算
            // table.settings()[0].oScroll.sY = newHeight;
            // table.draw();
        }else if(treeNode.ftype ==0){
            $(".typename").text("已选学院：" + rename(treeNode.name));
        //     var newHeight = (document.body.clientHeight - 220) + 'px'; // 示例：改变高度计算
        //     table.settings()[0].oScroll.sY = newHeight;
        //     table.draw();
        }

        if (treeNode.issc == 1) {
            ftypeid = treeNode.id;

            $('#mainTable').DataTable().ajax.reload(null, false);
            if (treeNode.ftype == 3) {
                $("#newadd").attr("style", "display:block;"); //显示
            } else {
                $("#newadd").attr("style", "display:none;"); //隐藏
            }
        } else {
            ftypeid = -1;
            $('#mainTable').DataTable().ajax.reload(null, false);
            $("#newadd").attr("style", "display:none;"); //隐藏
        }
    }

    function shuaxin(){
        $('#mainTable').DataTable().ajax.reload(null, false);
    }
    function shuaxin2(){
       gettreedata(2);
    }

    function adduser() {
        if (ftypeid != -1 ) {
            var index = layer.open({
                type: 2,
                area: ['800px', '400px'],
                fix: false, //不固定
                shade: 0.4,
                title: '添加学生信息',
                content: '/module/capability/student/classstudent/classstudentedit4.html?id=' + ftypeid+'&op=2'
                // , end: function () {
                //     gettreedata(2);
                // }
            });
        } else {
            toastr.error("选择班级后，再添加学生！");
        }
    }

    function delcalssstudent(fkeyid,name){
        layer.confirm('<b>' + name + '</b><br />确定要移除吗?', function (index) {
            $.ajax({
                type: 'POST',
                contentType: 'application/json;charset=UTF-8',
                url: '/s/tclass/delclassstudent',
                data: JSON.stringify({
                    id: fkeyid
                }),
                success: function (data) {
                    if (data.result == 'success') {
                        $('#mainTable').DataTable().ajax.reload(null, false);
                        toastr.success('删除成功！');
                        layer.close(layer.index);

                    }
                    if (data.result == 'error') {
                        toastr.error(data.error);
                    }
                },
                error: function (e) {
                    toastr.error(e.status);
                    toastr.error(e.responseText);
                }
            });
        });
    }

    function delcalsssandtudent(fkeyid,name){
        layer.confirm('确定要删除班级<b>' + name + '</b>及学生信息吗?', function (index) {
            $.ajax({
                type: 'POST',
                contentType: 'application/json;charset=UTF-8',
                url: '/s/tclass/delclasssandtudent',
                data: JSON.stringify({
                    id: fkeyid
                }),
                success: function (data) {
                    if (data.result == 'success') {
                        $('#mainTable').DataTable().ajax.reload(null, false);
                        toastr.success('删除成功！');
                        layer.close(layer.index);
                        gettreedata(2);
                        $(".typename").text("已选班级：" + "无");
                        $("#newadd").attr("style", "display:none;"); //隐藏
                    }
                    if (data.result == 'error') {
                        toastr.error(data.error);
                    }
                },
                error: function (e) {
                    toastr.error(e.status);
                    toastr.error(e.responseText);
                }
            });
        });
    }
    function rename(name){
        var newname;
        newname = name.replace(/<span[^>]*>([\s\S]*?)<\/span>/g, '$1');
        return newname;
    }
</script>
</body>
</html>