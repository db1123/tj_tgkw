<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <!--_only 独立样式 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
    <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
    <!--    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/demo.css" type="text/css">-->
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/metroStyle/metroStyle.css" type="text/css">
    <!--/_only 独立样式 -->
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .search-container {
        margin-bottom: 20px;
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /*#searchInput {*/
    /*    width: 60%;*/
    /*    padding: 10px;*/
    /*    font-size: 16px;*/
    /*    border: 1px solid #ddd;*/
    /*    border-radius: 4px;*/
    /*    margin-right: 10px;*/
    /*}*/
    #searchBtn {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #1890ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    #searchBtn:hover {
        background-color: #40a9ff;
    }
    .ztree-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .ztree-wrapper {
        width: 100%;
        height: 75vh;
        margin-bottom: 20px;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        padding: 15px;
        box-sizing: border-box;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .ztree-title {
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
    }
    .ztree {
        height: 65vh;
        overflow-y: auto;
        overflow-x: hidden;
    }
    /* 高亮样式 */
    .highlight {
        color: #ff4d4f;
        font-weight: bold;
    }
    @media (max-width: 768px) {
        .ztree-wrapper {
            width: 100%;
        }
    }
</style>
<body>
<div class="page-container">
    <div class="search-container">
        <h4 style="align-content: center;text-align: center;">考核条件：<span id="searchInput" ></span></h4>
<!--        <input type="text" id="searchInput" placeholder="考核条件名称..." readonly="readonly" >-->
<!--        <button id="searchBtn">搜索</button>-->
    </div>

    <div id="ztree-container" class="ztree-container">
        <!-- ZTree树形结构将在这里动态生成 -->
    </div>
</div>

<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/fuzzysearch.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    var courseabilityConditionID = getQueryStringByName('id');//考核条件ID
    var treeData;

    var searchInput;
    // 业务代码
    $(function () {
        //根据ID 查找所有涉及的能力信息并返回
        $.ajax({
            type: 'POST',
            contentType: 'application/json;charset=UTF-8',
            url: '/s/courseabilitycondition/querycourseabilityConditionTree',
            data: JSON.stringify({
                id: courseabilityConditionID
            }),
            success: function (data) {
                if (data.result == 'success') {
                    searchInput = data.searchInput;
                    $('#searchInput').text(data.searchInput);
                    treeData = data.treeDataall;
                    // 初始化生成所有树
                    generateZTrees(treeData);
                    searchNodes();
                }
                if (data.result == 'error') {
                    toastr.error(data.error);
                }
            },
            error: function (e) {
                toastr.error(e.status);
                toastr.error(e.responseText);
            }
        });
    });

    // 生成ZTree树形结构
    function generateZTrees(data) {
        const container = $('#ztree-container');
        container.empty();

        data.forEach((tree, index) => {
            const wrapper = $('<div class="ztree-wrapper"></div>');
            const title = $('<div class="ztree-title">' + tree.name + '</div>');
            const treeDiv = $('<ul id="tree' + index + '" class="ztree"></ul>');

            wrapper.append(title);
            wrapper.append(treeDiv);
            container.append(wrapper);

            // zTree配置
            const setting = {
                view: {
                    showLine: true,
                    selectedMulti: false,
                    fontCss: function(treeId, treeNode) {
                        return treeNode.highlight ? {color:"#ff4d4f", "font-weight":"bold"} : {};
                    }
                },
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pId",
                        rootPId: 0
                    }
                },
                callback: {
                    onClick: function(event, treeId, treeNode) {
                        console.log(treeNode);
                    }
                }
            };

            // 初始化zTree
            $.fn.zTree.init(treeDiv, setting, tree.nodes);
        });
    }

    // 在所有树中搜索
    function searchNodes() {
        const keyword =searchInput ; //$('#searchInput').val().trim();
        if (!keyword) {
            toastr.error('请输入考核条件');
            return;
        }

        const container = $('#ztree-container');
        const trees = container.find('.ztree-wrapper');
        let found = false;

        trees.each(function(index) {
            const treeObj = $.fn.zTree.getZTreeObj('tree' + index);
            const nodes = treeObj.getNodes();

            // 先取消之前的高亮
            treeObj.cancelSelectedNode();
            const allNodes = treeObj.transformToArray(nodes);
            allNodes.forEach(node => {
                node.highlight = false;
                treeObj.updateNode(node);
            });

            // 搜索匹配的节点
            const matchedNodes = treeObj.getNodesByParamFuzzy("name", keyword);
            if (matchedNodes.length > 0) {
                found = true;
                matchedNodes.forEach(node => {
                    node.highlight = true;
                    treeObj.updateNode(node);
                    treeObj.selectNode(node);
                    treeObj.expandNode(node.getParentNode(), true, true, true);
                });
            }
        });

        if (!found) {
            toastr.error('未找到匹配的节点');
        } else {
            // 滚动到第一个匹配的节点
            const firstTree = $.fn.zTree.getZTreeObj('tree0');
            const firstMatched = firstTree.getNodesByParam("highlight", true);
            if (firstMatched && firstMatched.length > 0) {
                firstTree.selectNode(firstMatched[0]);
                firstTree.scrollIntoView(firstMatched[0]);
            }
        }
    }
</script>
</body>
</html>