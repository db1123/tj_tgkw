<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="renderer" content="webkit|ie-comp|ie-stand">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport"
              content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
        <meta http-equiv="Cache-Control" content="no-siteapp"/>
        <!--_global 公共配置文件 -->
        <script language="javascript">var golbal_type = "admin";</script>
        <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
        <!--_only 独立样式 -->
        <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
        <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
        <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
        <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
        <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
        <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/demo.css" type="text/css">
        <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/metroStyle/metroStyle.css" type="text/css">
        <!--/_only 独立样式 -->
    </head>
    <style type="text/css">
        ul.ztree {
            margin-left: 20px;
            border: 1px solid #617775;
            background: #f0f6e4;
            width: 45vh;
            height: 100%;
            overflow-y: scroll;
            overflow-x: auto;
        }

        .sxts {
            display: inline-block;
            background-color: #ff9900;
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            text-align: center;
            line-height: 15px;
        }

    </style>
    <body>
        <div class="page-container" style="padding: 2px;">
            <div class="f-l " style="width: 98.8%; padding-top: 1px;">
                <div class="row cl">
                    <div class="col-md-3">
                        <div class="card-body">
                            <div class="zTreeDemoBackground left">
                                <div>
                                    <input id="keyword" type="search" placeHolder="搜索关键字" style="margin-top: 20px;margin-left: 20px;height: 30px;width: 46.5vh;border: 1px solid #DDDDDD;"/>
                                </div>
                                <ul id="treeDemo2" class="ztree"></ul>
                                <ul id="treeDemo" class="ztree"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="card-body" style="position:fixed; left:25%; top:20px;width: 74%" >
                            <div class="panel panel-default">
                                <div class="panel-header">已选类型：<strong class="typename">无</strong></div>
                                <div class="panel-body">
                                    <div class="f-l text-l" id="newadd" style="display: none;">
                                        <button type="button" class="btn btn-default size-S my-btn"
                                                onclick="shangchuan()"><i
                                                class=" fa fa-user-plus"></i>
                                            上传文件
                                        </button>
                                    </div>
                                    <table id="mainTable" class="display compact" style="width: 99.8%;"></table>
                                    <a id="downloada" download="" href="" target="_blank"><span id="downloadspan"
                                                                                                style="display: none;">下载文件</span></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
        <script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
        <script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
        <script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
        <script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
        <script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
        <script src="/plugins/select2/js/select2.full.min.js"></script>
        <script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="/javascript/jquery.base64.js"></script>
        <script type="text/javascript">
            var xfno;
            var showtype = getQueryStringByName('showtype');
            var projectid = -1;//getQueryStringByName('id');//项目ID
            var projectid2 = -1;
            var zNodes = [];
            var treesetting = {};
            var treesetting2 = {};
            var treeObj = null;
            var ftypeid = -1;
            var ftypename = "";
            var pfstate = -1;

            var ftype = -1;
            var filename = "";//文件名称
            var feditionNo = 1;//当前版本


            // 业务代码
            $(function () {
                $("#newadd").attr("style", "display:none;"); //隐藏

                $("#downloada").hide();


                $("#newadd").attr("style", "display:none;"); //隐藏


                treesetting = {
                    view: {
                        // addHoverDom: addHoverDom,
                        // removeHoverDom: removeHoverDom,
                        selectedMulti: false,
                        showTitle: false, // 确保显示悬停提示
                        nameIsHTML: true,
                    },
                    check: {
                        enable: false
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    },
                    edit: {
                        enable: false
                    },
                    callback: {
                        onClick: zTreeOnClick
                    }
                };

                treesetting2 = {
                    view: {
                        // addHoverDom: addHoverDom,
                        // removeHoverDom: removeHoverDom,
                        selectedMulti: false,
                        showTitle: false, // 确保显示悬停提示
                        nameIsHTML: true,
                    },
                    check: {
                        enable: false
                    },
                    data: {
                        simpleData: {
                            enable: true
                        }
                    },
                    edit: {
                        enable: false
                    },
                    callback: {
                        onClick: zTreeOnClick2
                    }
                };


                gettreedata2("1");


                // 封装表格
                $('#mainTable').DataTable({
                    processing: true,
                    serverSide: true,
                    ajax: {
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/s/projectFiles/queryprojectFiles', // 调用地址
                        data: function (d) {
                            return JSON.stringify($.extend({}, d, {
                                page: d.start / d.length + 1, // 当前页
                                results: d.length, // 每页显示条数
                                id: projectid,
                                ftypeid: ftypeid,
                                ftype: ftype
                            }));
                        },
                        dataSrc: function (json) {
                            json.recordsFiltered = json.total;  // 总行数
                            json.recordsTotal = json.page; // 当前页数
                            return json.list;
                        },
                        error: function (xhr, status, error) {
                            toastr.error(xhr);
                        }
                    },
                    columns: [
                        {title: '文件名称', data: 'FFileName'},
                        {title: '版本', data: 'FEdition',width: 35,},
                        {title: '上传者', data: 'FCID',width: 50,
                            render: function (data, type, row) {
                                return row.FCIDName;
                            }
                        },
                        {title: '备注', data: 'FNote'},
                        {
                            title: '操作',
                            data: 'FState',
                            width: 90,
                            orderable: false,
                            render: function (data, type, row) {
                                var yl = '<button  class="btn btn-default  size-MINI " title="预览" onclick="yulan(\'' + row.key + '\')"><i class="fa fa-eye" aria-hidden="true" /></i> </button> ';
                                var xz = '<button  class="btn btn-default  size-MINI " title="下载" onclick="xiazai(\'' + row.key + '\')"><i class="fa fa-download" aria-hidden="true"></i></button>&nbsp;';
                                var ls = '<button  class="btn btn-default  size-MINI " title="历史" onclick="lishi(\'' + row.FFileID + '\')"><i class="fa fa-columns" aria-hidden="true" /></i></button>&nbsp;';
                                return yl + xz + ls;
                            }
                        }
                    ],
                    scrollY: (document.body.clientHeight * 0.5) + 'px',
                    scrollX: true,
                    paging: true, // 是否开启本地分页
                    pageLength: 5, // 改变初始化页长度（每页多少条数据）
                    pagingType: 'full_numbers', // 首页，尾页，上一页和下一页四个按钮,加上数字按钮
                    lengthChange: false, // 是否允许因子改变表格每页显示的记录数
                    searching: false, // 是否允许Datatables开启本地搜索
                    ordering: true, // 是否允许Datatables开启排序
                    info: true, // 控制是否显示表格左下角的信息
                    language: DataTablesLanguage
                });


            });

            function gettreedata2(xmno) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/projectFiles/querapplyxm',
                    data: JSON.stringify({
                        ftype: showtype,
                    }),
                    success: function (data) {
                        if (data.result == 'success') {
                            zNodes = data.zNodes;
                            $.fn.zTree.init($("#treeDemo2"), treesetting2, zNodes);
                            fuzzySearch('treeDemo2','#keyword',null,true); //初始化模糊搜索方法
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }


            function gettreedata(types) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/projectFiles/querapplyfiletype',
                    data: JSON.stringify({
                        ftype: types,
                        projectid:projectid
                    }),
                    success: function (data) {
                        if (data.result == 'success') {
                            zNodes = data.zNodes;

                            treeObj = $.fn.zTree.init($("#treeDemo"), treesetting, zNodes);

                            treeObj.expandAll(true);
                            var nodes = treeObj.getSelectedNodes();

                            if (nodes.length > 0) {
                                for (var i = 0; i < nodes.length; i++) {
                                    treeObj.expandNode(nodes[i], true, true, true);
                                }
                            }
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }

            function zTreeOnClick(event, treeId, treeNode) {

                if (treeNode.issc == 1) {
                    ftypeid = treeNode.id;
                    $(".typename").text(treeNode.title);
                    $('#mainTable').DataTable().ajax.reload(null, false);
                } else {
                    ftypeid = -1;
                    $('#mainTable').DataTable().ajax.reload(null, false);
                    $(".typename").text('无');

                }
            }

            function zTreeOnClick2(event, treeId, treeNode) {

                if (treeNode.issc == 1) {
                    projectid = treeNode.id;
                    projectid2 = treeNode.projectid;
                    ftype = treeNode.ftype;
                    gettreedata(treeNode.ftype);

                    $('#mainTable').DataTable().ajax.reload(null, false);
                    $(".typename").text('无');
                } else {
                    projectid = -1;
                    ftype = -1;
                    gettreedata(-1);
                    $('#mainTable').DataTable().ajax.reload(null, false);
                    $(".typename").text('无');

                }
            }


            function yulan(fkey) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/projectFiles/getmyprojectUrl',
                    data: JSON.stringify({
                        id: fkey,
                        ip:YULANIP,
                        ftype : 1,
                        FProjectID:projectid
                    }),
                    success: function (data) {
                        if (data.result == 'success') {
                            //console.log("url:" + data.url);
                            var url = data.url;
                            var fileurl = YULANIP2 + 'onlinePreview?url=' + encodeURIComponent($.base64.encode((url)));
                            window.open(fileurl);
                        }
                        if (data.result == 'error') {
                            toastr.error(data.error);
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }

            function xiazai(fkey) {
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json;charset=UTF-8',
                    url: '/s/projectFiles/getmyprojectUrl',
                    data: JSON.stringify({
                        id: fkey,
                        ip: YULANIP,
                        ftype: 2,
                        FProjectID: projectid2
                    }),
                    success: function (data) {
                        if (data.result == 'success') {
                            $("body").mLoading("show");
                            setTimeout(function () {
                                $('.mloading-text').html('正在获取文件信息...');
                                $("#downloada").attr('download', data.filename);
                                $("#downloada").attr('href', data.url);
                                setTimeout(function () {
                                    $('.mloading-text').html('获取完成准备下载...');
                                    $("#downloadspan").trigger("click");
                                    setTimeout(function () {
                                        $('#mainTable').DataTable().ajax.reload(null, false);
                                        $("body").mLoading("hide");
                                    }, 1000);
                                }, 1000);
                            }, 1000);

                        }
                        if (data.result == 'error') {
                            toastr.error(data.error);
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                    }
                });
            }


            // // 删除按钮点击事件
            // function onClickBtnDel(id, name) {
            //     layer.confirm('<b>' + name + '</b><br />确定要删除吗?', function(index){
            //         $.ajax({
            //             type: 'POST',
            //             contentType: 'application/json;charset=UTF-8',
            //             url: '/s/projectFiles/delprojectfiles',
            //             data: JSON.stringify({
            //                 id: id,
            //                 projectid:projectid
            //             }),
            //             success: function(data) {
            //                 if(data.result == 'success'){
            //                     $('#mainTable').DataTable().ajax.reload(null, false);
            //                     toastr.success('删除成功！');
            //                     layer.close(layer.index);
            //                 }if(data.result == 'error') {
            //                     toastr.error(data.error);
            //                     layer.close(layer.index);
            //                 }
            //             },
            //             error: function(e){
            //                 toastr.error(e.status);
            //                 toastr.error(e.responseText);
            //             }
            //         });
            //     });
            // }
            //弹出历史数据框
            function lishi(fkeyid) {
                top.layer_show('历史项目文件', '/module/myproject/myprojectfilels.html?id=' + fkeyid + '&projectid=' + projectid2, '800', '500');
            }

            //升版
            // function shengban(fkeyid,name,no) {
            //     feditionNo = no;
            //     filename = name;
            //     layer_show('项目文件升版', 'myprojectfileshengban.html?id=' + fkeyid, '1000', '400');
            // }



            /**
             *
             * @param zTreeId ztree对象的id,不需要#
             * @param searchField 输入框选择器
             * @param isHighLight 是否高亮,默认高亮,传入false禁用
             * @param isExpand 是否展开,默认合拢,传入true展开
             * @returns
             */
            function fuzzySearch(zTreeId, searchField, isHighLight, isExpand){
                var zTreeObj = $.fn.zTree.getZTreeObj(zTreeId);//获取树对象
                if(!zTreeObj){
                    alter("获取树对象失败");
                }
                var nameKey = zTreeObj.setting.data.key.name; //获取name属性的key
                isHighLight = isHighLight===false?false:true;//除直接输入false的情况外,都默认为高亮
                isExpand = isExpand?true:false;
                zTreeObj.setting.view.nameIsHTML = isHighLight;//允许在节点名称中使用html,用于处理高亮

                var metaChar = '[\\[\\]\\\\\^\\$\\.\\|\\?\\*\\+\\(\\)]'; //js正则表达式元字符集
                var rexMeta = new RegExp(metaChar, 'gi');//匹配元字符的正则表达式

                // 过滤ztree显示数据
                function ztreeFilter(zTreeObj,_keywords,callBackFunc) {
                    if(!_keywords){
                        _keywords =''; //如果为空，赋值空字符串
                    }

                    // 查找符合条件的叶子节点
                    function filterFunc(node) {
                        if(node && node.oldname && node.oldname.length>0){
                            node[nameKey] = node.oldname; //如果存在原始名称则恢复原始名称
                        }
                        //node.highlight = false; //取消高亮
                        zTreeObj.updateNode(node); //更新节点让之前对节点所做的修改生效
                        if (_keywords.length == 0) {
                            //如果关键字为空,返回true,表示每个节点都显示
                            zTreeObj.showNode(node);
                            zTreeObj.expandNode(node,isExpand); //关键字为空时是否展开节点
                            return true;
                        }
                        //节点名称和关键字都用toLowerCase()做小写处理
                        if (node[nameKey] && node[nameKey].toLowerCase().indexOf(_keywords.toLowerCase())!=-1) {
                            if(isHighLight){ //如果高亮，对文字进行高亮处理
                                //创建一个新变量newKeywords,不影响_keywords在下一个节点使用
                                //对_keywords中的元字符进行处理,否则无法在replace中使用RegExp
                                var newKeywords = _keywords.replace(rexMeta,function(matchStr){
                                    //对元字符做转义处理
                                    return '\\' + matchStr;

                                });
                                node.oldname = node[nameKey]; //缓存原有名称用于恢复
                                //为处理过元字符的_keywords创建正则表达式,全局且不分大小写
                                var rexGlobal = new RegExp(newKeywords, 'gi');//'g'代表全局匹配,'i'代表不区分大小写
                                //无法直接使用replace(/substr/g,replacement)方法,所以使用RegExp
                                node[nameKey] = node.oldname.replace(rexGlobal, function(originalText){
                                    //将所有匹配的子串加上高亮效果
                                    var highLightText =
                                        '<span style="color: whitesmoke;background-color: darkred;">'
                                        + originalText
                                        +'</span>';
                                    return  highLightText;
                                });
                                //================================================//
                                //node.highlight用于高亮整个节点
                                //配合setHighlight方法和setting中view属性的fontCss
                                //因为有了关键字高亮处理,所以不再进行相关设置
                                //node.highlight = true;
                                //================================================//
                                zTreeObj.updateNode(node); //update让更名和高亮生效
                            }
                            zTreeObj.showNode(node);//显示符合条件的节点
                            return true; //带有关键字的节点不隐藏
                        }

                        zTreeObj.hideNode(node); // 隐藏不符合要求的节点
                        return false; //不符合返回false
                    }
                    var nodesShow = zTreeObj.getNodesByFilter(filterFunc); //获取匹配关键字的节点
                    processShowNodes(nodesShow, _keywords);//对获取的节点进行二次处理
                }

                /**
                 * 对符合条件的节点做二次处理
                 */
                function processShowNodes(nodesShow,_keywords){
                    if(nodesShow && nodesShow.length>0){
                        //关键字不为空时对关键字节点的祖先节点进行二次处理
                        if(_keywords.length>0){
                            $.each(nodesShow, function(n,obj){
                                var pathOfOne = obj.getPath();//向上追溯,获取节点的所有祖先节点(包括自己)
                                if(pathOfOne && pathOfOne.length>0){ //对path中的每个节点进行操作
                                    // i < pathOfOne.length-1, 对节点本身不再操作
                                    for(var i=0;i<pathOfOne.length-1;i++){
                                        zTreeObj.showNode(pathOfOne[i]); //显示节点
                                        zTreeObj.expandNode(pathOfOne[i],true); //展开节点
                                    }
                                }
                            });
                        }else{ //关键字为空则显示所有节点, 此时展开根节点
                            var rootNodes = zTreeObj.getNodesByParam('level','0');//获得所有根节点
                            $.each(rootNodes,function(n,obj){
                                zTreeObj.expandNode(obj,true); //展开所有根节点
                            });
                        }
                    }
                }

                //监听关键字input输入框文字变化事件
                $(searchField).bind('input propertychange', function() {
                    var _keywords = $(this).val();
                    searchNodeLazy(_keywords); //调用延时处理
                });

                var timeoutId = null;
                // 有输入后定时执行一次，如果上次的输入还没有被执行，那么就取消上一次的执行
                function searchNodeLazy(_keywords) {
                    if (timeoutId) { //如果不为空,结束任务
                        clearTimeout(timeoutId);
                    }
                    timeoutId = setTimeout(function() {
                        ztreeFilter(zTreeObj,_keywords);    //延时执行筛选方法
                        $(searchField).focus();//输入框重新获取焦点
                    }, 500);
                }
            }
        </script>
    </body>
</html>