<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<!--_global 公共配置文件 -->
<script language="javascript">var golbal_type="admin";</script>
<script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
<!--_only 独立样式 -->
<link rel="stylesheet" href="/plugins/select2/css/select2.min.css" />
<link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css" />
<link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css" />
<link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css" />
<link rel="stylesheet" href="/plugins/mTips/mTips.css" />
<link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css" />
<!--/_only 独立样式 -->
</head>
<body>
<div class="page-container" style="padding: 2px;">
  <div class="f-l text-l">
    <span class="dropDown dropDown_hover">
      <a class="dropDown_A btn btn-default size-S my-btn"><i class=" fa fa-plus"></i> 新增</a>
      <ul class="dropDown-menu menu radius box-shadow">
        <li><a href="#" onclick="BasicValues(1)"><i class=" fa fa-plus"></i> 普通参数</a></li>
        <li><a href="#" onclick="StandardValues(1)"><i class=" fa fa-plus"></i> 标准SQL</a></li>
        <li><a href="#" onclick="CustomSQLValues(1)"><i class=" fa fa-plus"></i> 自定义SQL</a></li>
        <li><a href="#" onclick="JSCodeValues(1)"><i class=" fa fa-plus"></i> 公式&约束</a></li>
        <li><a href="#" onclick="URLValues(1)"><i class=" fa fa-plus"></i> URL外部引用</a></li>
      </ul>
    </span>
  </div>
  <div class="f-r text-r">
    <select class="param-form-select-type" style="width:200px"></select>
    <select class="param-form-select-classify" style="width: 150px;">
      <option value="-1">全部分类</option>
      <option value="1">普通节点</option>
      <option value="2">标准SQL</option>
      <option value="3">自定义SQL</option>
      <option value="4">公式&约束</option>
      <option value="5">URL引用</option>
    </select>
    <input type="text" class="input-text size-S param-form-text-title" style="width:300px" placeholder="输入标题" />
    <button type="button" class="btn btn-default size-S my-btn param-btn-search-fun"><i class="Hui-iconfont">&#xe665;</i> 搜索</button>
  </div>
	<div class="f-l table-panel">
    <table id="paramTable" class="display compact" style="width: 99.8%;"></table>
	</div>
</div>

<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
<script type="text/javascript" src="/plugins/mTips/mTips.js"></script>
<script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script type="text/javascript">
// 业务代码
$(function(){
  // 初始化类型树形下拉框
  $.ajax({
    type: 'POST',
    contentType: 'application/json',
    url: '/s/paramType/queryParamTypeALL', // 调用地址
    async: false,
    success: function(data) {
      var newObj2 = Object.assign([], data.zNodes);
      newObj2.push({id: 1, pId: 0, name: '全部', open: true});
      $('.param-form-select-type').select2ztree({
        textField: 'name',
        titleField: 'name',
        placeholder: '请选择类型',
        ztree: {
          setting: {
            view: {
              dblClickExpand: false
            },
            data: {
              simpleData: {
                enable: true,
                idKey: "id",
                pIdKey: "pId",
                rootPId: 0
              }
            }
          },
          zNodes: newObj2
        },
        language: "zh-CN"
      });
    },
    error : function(e) {
      toastr.error(e.status);
      toastr.error(e.responseText);
    }
  });
  // 初始化分类下拉框
  $(".param-form-select-classify").select2({
    placeholder: '请选择分类',
    language: "zh-CN"
  });
  // 数据-表格
  $('#paramTable').DataTable({
    processing: true,
    serverSide: true,
    ajax: {
      type: 'POST',
      contentType: 'application/json',
      url: '/s/param/queryParam', // 调用地址
      data: function ( d ) {
        return JSON.stringify( $.extend( {}, d, {
          page: d.start/d.length+1, // 当前页
          results: d.length, // 每页显示条数
          type: $('.param-form-select-type').val(),
          classify: $('.param-form-select-classify').val(),
          title: $('.param-form-text-title').val()
        } ) );
      },
      dataSrc: function (json) {
        json.recordsFiltered = json.total;  // 总行数
        json.recordsTotal = json.page; // 当前页数
        return json.list;
      },
      error: function (xhr, status, error) {
        toastr.error(xhr);
      }
    },
    columns: [
      { title: '编码', data: 'f_no', width: 80 },
      { title: '类型', data: 'f_type', width: 150, render: function (data, type, row) {return row.type_name} },
      {
        title: '分类',
        data: 'f_classify',
        width: 60,
        render: function (data, type, row) {
          switch (data) {
            case 1:
              return '普通参数';
              break;
          
            case 2:
              return '标准SQL';
              break;

            case 3:
              return '自定义SQL';
              break;

            case 4:
              return '公式&约束';
              break;

            case 5:
              return 'URL引用';
              break;

            default:
              return '无';
              break;
          }
        }
      },
      { title: '参数符号', data: 'f_title', width: 120 },
      { title: '参数名', data: 'f_subtitle', width: 180 },
      {
        title: '说明',
        data: 'f_classify',
        orderable: false,
        render: function (data, type, row) {
          let temp = '';
          switch (data) {
            case 1: // 普通参数
            case 4: // 公式&约束
              temp = "<div data-mtpis='<img width=200 src=\"" + row.f_img + "\" />" + row.f_memo + "' data-mtpis-style='info'>【<i class='fa fa-hand-o-up' aria-hidden='true' style='padding-right: 1px;'></i>鼠标悬停查看说明】</div>";
              break;

            case 2: // 标准SQL
            case 3: // 自定义SQL
              temp = '【服务器】' + wordlimit(row.server_name, 50);
              break;

            case 5:
              temp = '【网址】' + wordlimit(row.f_url, 50);
              break;

            default:
              temp = '无';
              break;
          }
          return temp;
        }
      },
      { title: '创建时间', data: 'f_c_date', width: 108, visible:false },
      {
        title: '状态',
        data: 'f_state',
        width: 35,
        orderable: false,
        render: function (data, type, row) {
          if (data == 1) {
            return '<button type="button" class="btn btn-success size-MINI" onclick="onClickParamBtnState(\''+row.key+'\','+row.f_state+',\''+row.f_title+'\')"><i class="fas fa-toggle-on"></i> 启用</button>';
          } else {
            return '<button type="button" class="btn btn-warning size-MINI" onclick="onClickParamBtnState(\''+row.key+'\','+row.f_state+',\''+row.f_title+'\')"><i class="fas fa-toggle-off"></i> 禁用</button>';
          }
        }
      },
      {
        title: '关系',
        data: 'key',
        width: 30,
        orderable: false,
        render: function (data, type, row) {
          return '<button type="button" class="btn btn-secondary size-MINI" onclick="onClickRelationSet(\''+row.key+'\')"><i class="fas fa-code-branch"></i> 设置</button>';
        }
      },
      {
        title: '操作',
        data: 'f_classify',
        width: 88,
        orderable: false,
        render: function (data, type, row) {
          var temp = '';
          switch (data) {
            case 1:
              temp += '<button type="button" class="btn btn-secondary size-MINI" onclick="BasicValues(2,\''+row.key+'\')"><i class="fas fa-edit"></i> 编辑</button>';
              break;

            case 2:
              temp += '<button type="button" class="btn btn-secondary size-MINI" onclick="StandardValues(2,\''+row.key+'\')"><i class="fas fa-edit"></i> 编辑</button>';
              break;

            case 3:
              temp += '<button type="button" class="btn btn-secondary size-MINI" onclick="CustomSQLValues(2,\''+row.key+'\')"><i class="fas fa-edit"></i> 编辑</button>';
              break;

            case 4:
              temp += '<button type="button" class="btn btn-secondary size-MINI" onclick="JSCodeValues(2,\''+row.key+'\')"><i class="fas fa-edit"></i> 编辑</button>';
              break;
          
            case 5:
              temp += '<button type="button" class="btn btn-secondary size-MINI" onclick="URLValues(2,\''+row.key+'\')"><i class="fas fa-edit"></i> 编辑</button>';
              break;

            default:
              break;
          }
          temp += '<button type="button" class="btn btn-danger size-MINI" onclick="onClickParamBtnDel(\''+row.key+'\',\''+row.f_title+'\')"><i class="fas fa-trash"></i> 删除</button>';
          return temp;
        }
      }
    ],
    scrollY: (document.body.clientHeight-100) + 'px',
    scrollX: true,
    paging: true, // 是否开启本地分页
    pageLength: 20, // 改变初始化页长度（每页多少条数据）
    pagingType: 'full_numbers', // 首页，尾页，上一页和下一页四个按钮,加上数字按钮
    lengthChange: false, // 是否允许流程项目改变表格每页显示的记录数
    searching: false, // 是否允许Datatables开启本地搜索
    ordering: true, // 是否允许Datatables开启排序
    order: [[ 5, "desc" ]],
    info: true, // 控制是否显示表格左下角的信息
    language: DataTablesLanguage
  });
  // 查询按钮点击事件
  $('.param-btn-search-fun').on('click', function(){
    $('#paramTable').DataTable().ajax.reload(null, false);
  });
});
// 新增或者修改点击事件
function BasicValues(op, fKey) {
  if (op == 1) { // 新增
    layer_show('新增普通节点信息','editBasic.html?op=1','','');
  } else { // 修改
    layer_show('修改普通节点信息','editBasic.html?op=2&id='+fKey,'','');
  }
}
function StandardValues(op, fKey) {
  if (op == 1) { // 新增
    layer_show('新增标准SQL信息','editStandard.html?op=1','900','500');
  } else { // 修改
    layer_show('修改标准SQL信息','editStandard.html?op=2&id='+fKey,'900','500');
  }
}
function CustomSQLValues(op, fKey) {
  if (op == 1) { // 新增
    layer_show('新增自定义SQL信息','editCustomSQL.html?op=1','1000','580');
  } else { // 修改
    layer_show('修改自定义SQL信息','editCustomSQL.html?op=2&id='+fKey,'1000','580');
  }
}
function JSCodeValues(op, fKey) {
  if (op == 1) { // 新增
    layer_show('新增公式&约束信息','editJSCode.html?op=1','','');
  } else { // 修改
    layer_show('修改公式&约束信息','editJSCode.html?op=2&id='+fKey,'','');
  }
}
function URLValues(op, fKey) {
  if (op == 1) { // 新增
    layer_show('新增引用信息','editURL.html?op=1','900','350');
  } else { // 修改
    layer_show('修改引用信息','editURL.html?op=2&id='+fKey,'900','350');
  }
}
// 状态按钮点击事件
function onClickParamBtnState(id, state, name) {
  var text = '';
  if (state == 1) {
    text = '<b>' + name + '</b><br />确定要&nbsp;<b>禁用</b>&nbsp;吗?';
  } else {
    text = '<b>' + name + '</b><br />确定要&nbsp;<b>启用</b>&nbsp;吗?';
  }
  layer.confirm(text, function(index){
		$.ajax({
      type: 'POST',
      contentType: 'application/json;charset=UTF-8',
      url: '/s/param/stateParam',
      data: JSON.stringify({
        id: id,
        state: state
      }),
      success: function(data) {
        if(data.result == 'success'){
          $('#paramTable').DataTable().ajax.reload(null, false);
          toastr.success('状态改变成功！');
          layer.close(layer.index);
        }if(data.result == 'error') {
          toastr.error(data.error)
        }
      },
      error: function(e){
        toastr.error(e.status);
        toastr.error(e.responseText);
      }
    });		
	});
}
// 参数关系设置
function onClickRelationSet(fKey) {
  layer_show('设置参数关系','editRelation.html?id='+fKey,'1000','600');
}
// 删除按钮点击事件
function onClickParamBtnDel(id, name) {
  layer.confirm('<b>' + name + '</b><br />确定要删除吗?', function(index){
    $.ajax({
      type: 'POST',
      contentType: 'application/json;charset=UTF-8',
      url: '/s/param/delParam',
      data: JSON.stringify({
        id: id
      }),
      success: function(data) {
        if(data.result == 'success'){
          $('#paramTable').DataTable().ajax.reload(null, false);
          toastr.success('删除成功！');
          layer.close(layer.index);
        }if(data.result == 'error') {
          toastr.error(data.error)
        }
      },
      error: function(e){
        toastr.error(e.status);
        toastr.error(e.responseText);
      }
    });
	});
}
</script> 
</body>
</html>