<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <!--_only 独立样式 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
    <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
    <!--/_only 独立样式 -->
    <link rel="stylesheet" href="/module/capability/interface/css/jsoneditor.min.css"/>
    <script src="/module/capability/interface/css/jsoneditor.min.js"></script>
</head>
<style>
    .toolbar-bottom-btn {
        position: absolute;
        bottom: 1vh;
        left: 50%;
        transform: translate(-50%, 0);
    }

    .toolbar-bottom-line {
        position: absolute;
        bottom: 6vh;
        left: 50%;
        transform: translate(-50%, 0);
        width: 100%;
        border-top: 1px solid #cfcfcf;
    }



    /* 保持样式统一且可点击 */
    .btn-upload {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .upload-url {
        flex: 1;
        min-width: 200px;
        margin-right: 5px; /* 添加间距 */
    }



    /* 确保标签可点击 */
    .btn-upload label {
        cursor: pointer;
        margin: 0;
    }

    /* 统一按钮样式 */
    .btn-primary {
        padding: 6px 12px; /* Bootstrap 默认按钮内边距 */
        font-size: 14px;
        line-height: 1.42857;
        text-align: center;
        white-space: nowrap; /* 防止文字换行 */
        cursor: pointer;
        border-radius: 4px; /* 圆角 */
    }

    /* 文件上传按钮样式 */
    .btn-upload label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 34px; /* 与输入框高度一致 */
    }

    /* 隐藏原生文件输入 */
    .input-file {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        position: absolute;
        z-index: -1;
    }

</style>
<body>
<article class="page-container">
    <form action="" method="post" class="form form-horizontal" id="enrollmentscoursepjForm">
        <div class="row cl shangchuan" 　 style="display: block;">
            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>导入评语模板：</label>
            <div class="formControls col-xs-10 col-sm-10">
                <span class="btn-upload form-group">
                    <input class="input-text upload-url radius" type="text" name="uploadfile-1" id="uploadfile-1" readonly>
                    <label for="uploadfile" class="btn btn-primary radius"> <!-- 关键：用label包裹，并关联input的id -->
                        <i class="fa fa-cloud-upload" aria-hidden="true"></i> 浏览文件
                    </label>
                    <input type="file" multiple name="file-1" class="input-file" id="uploadfile" accept=".xlsx">
                </span>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>评价模版：</label>
            <div class="formControls col-xs-10 col-sm-10" style="display: flex; gap: 10px;">
                <select name="interface" id="interface" style="flex: 1; min-width: 0;"> <!-- flex:1 让下拉框占满剩余空间 -->
                </select>
                <input type="button" class="btn btn-primary" onclick="yulanmodel()" value=' 模版预览' style="white-space: nowrap;">
            </div >
        </div>
        <div class="row cl">
            <div style="display:none;">
                <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>接口名称：</label>
                <div class="formControls col-xs-4 col-sm-4">
                    <input type="text" class="input-text" name="FName" id="FName" style="width: 100%;"/>
                </div>
            </div>

            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>评价模版调用成熟度：</label>
            <div class="formControls col-xs-10 col-sm-10">
                <input type="number" class="input-text" name="FMaturity" id="FMaturity" min="0.01" max="1" step="0.01"
                       placeholder="格式：0.01-1的数字" style="width: 100%"/>
            </div>
        </div>


        <div class="row cl">
            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>评价模版输入参数：</label>
            <div class="formControls col-xs-10 col-sm-10">
                <div id="jsonEditorContainer" style="width:100%; height: 40vh;"></div>
                <input type="hidden" id="FInputParameters" name="FInputParameters">
            </div>
        </div>

        <div class="row cl" style="display: none;">
            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>返回参数：</label>
            <div class="formControls col-xs-10 col-sm-10">
                <div id="jsonEditorContainer2" style="width: 100%; height: 19vh;"></div>
                <input type="hidden" id="FReturnParameters" name="FReturnParameters">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-xs-2 col-sm-2"><span class="c-red">*</span>评价模版数据匹配要求：</label>
            <div class="formControls col-xs-10 col-sm-10">
                <textarea placeholder='例：请列出该项目中的存在的主要功能、结构以及数据存储方式' id="FRequire"
                          name="FRequire" rows="8" cols="30" class="input-text"
                          style="width: 100%;height:12vh; box-sizing: border-box; border: solid 1px #ddd;"></textarea>
            </div>
        </div>
        <div class="toolbar-bottom-line"></div>
        <div class="toolbar-bottom-btn">
            <input class="btn btn-primary radius mr-20" type="submit" value="&nbsp;&nbsp;评价&nbsp;&nbsp;"/>
            <input class="btn btn-default radius ml-20" type="button" value="&nbsp;&nbsp;取消&nbsp;&nbsp;"
                   onclick="layer_close()"/>
        </div>
        <input type="hidden" value="" name="FKeyID" id="FKeyID"/>
        <input type="hidden" value="" name="FJKID" id="FJKID"/>
        <input type="hidden" value="" name="FCEID" id="FCEID"/>

    </form>
</article>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="/nui-ad/lib/jquery.validation/1.14.0/messages_zh.js"></script>

<script type="text/javascript">
    // 编辑框状态 1新建 2修改
    var op = getQueryStringByName('op');
    var selectinterfaceID;
    top.classstudentpage = this;
    var enrollmentscourseID;
    var jsonEditor;
    var jsonEditor2;
    var FJKID;
    // 业务代码
    $(function () {
        var container = document.getElementById('jsonEditorContainer');
        jsonEditor = new JSONEditor(container, {
            mode: 'code',
            theme: 'ajv',
            onChange: function () {
                // 可以添加实时验证逻辑
            }
        });

        var container2 = document.getElementById('jsonEditorContainer2');
        jsonEditor2 = new JSONEditor(container2, {
            mode: 'code',
            theme: 'schema',
            onChange: function () {
                // 可以添加实时验证逻辑
            }
        });
        selectinterfaceID = $("#interface").select2({
            placeholder: '请选择评价模版',
            ajax: {
                type: 'POST',
                url: "/s/courseenrollment/queryDatainterfaceSelect",
                dataType: 'json',
                data: function (params) {
                    return {
                        search: params.term,
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.list
                    };
                },
                delay: 800,
                cache: true
            },
            language: "zh-CN"
        });


        // 监听下拉列表的 change 事件
        selectinterfaceID.on('change', function () {
            // 获取下拉列表当前选中的值
            var selectedValue = $(this).val();
            $('#FJKID').val(selectedValue);
            FJKID = selectedValue;
            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                url: '/s/interface/queryinterfaceInfo', // 调用地址
                data: JSON.stringify({
                    id: selectedValue
                }),
                async: false,
                success: function (data) {
                    $('#FName').val(data.info.FName);
                    $('#FInputParameters').val(data.info.FInputParameters);
                    // 创建JSON编辑器


                    // 设置初始值
                    try {
                        jsonEditor.set(JSON.parse(data.info.FInputParameters));
                    } catch (e) {
                        // 如果解析失败，设置为空对象
                        jsonEditor.set({});
                        layer.msg('当前数据格式不正确，已重置为默认值', {icon: 5});
                    }


                    $('#FReturnParameters').val(data.info.FReturnParameters);


                    // 设置初始值
                    try {
                        jsonEditor2.set(JSON.parse(data.info.FReturnParameters));
                    } catch (e) {
                        // 如果解析失败，设置为空对象
                        jsonEditor2.set({});
                        layer.msg('当前数据格式不正确，已重置为默认值', {icon: 5});
                    }

                    $('#FRequire').val(data.info.FRequire);
                    $('#FMaturity').val(data.info.FMaturity);

                    $('#FJKID').val(data.info.key);
                },
                error: function (e) {
                    toastr.error(e.status);
                    toastr.error(e.responseText);
                }
            });
        });

        // 检验数据
        var userValidate = $('#enrollmentscoursepjForm').validate({
            rules: {

                interface: {
                    required: true
                },

                FName: {
                    required: true
                },

                FInputParameters: {
                    required: true
                },
                FReturnParameters: {
                    required: true
                },
                FRequire: {
                    required: true
                },
                Finterfacetype: {
                    required: true
                },
                FMaturity: {
                    required: true,
                    range: [0.01, 1]
                }

            },
            messages: {
                interface: {
                    required: '*请选择评价模版'
                },
                FName: {
                    required: '*请输入数据接口名称'
                },
                Finterfacetype: {
                    required: '*请选择数据接口模板'
                },
                FInputParameters: {
                    required: '*请编辑接口输入参数'
                },
                FReturnParameters: {
                    required: '*请编辑接口返回参数'
                },
                FRequire: {
                    required: '*请输入返回要求'
                },
                FMaturity: {
                    required: '*请输入接口提问成熟度'
                }
            },
            onfocusout: false, // 是否在获取焦点时验证
            onkeyup: false, // 是否在敲击键盘时验证
            focusInvalid: false, //提交表单后，（第一个）未通过验证的表单获得焦点
            focusCleanup: true, // 当未通过验证的元素获得焦点时，移除错误提示
            success: 'valid',
            submitHandler: function () {
                $("body").mLoading("show");
                // 获取参数
                // var data = form2Json('enrollmentscoursepjForm');
                var form = new FormData(document.getElementById('enrollmentscoursepjForm'));
                form.append("FJKID",$("#FJKID").val());
                form.append("FReturnParameters",$("#FReturnParameters").val());
                form.append("FInputParameters",$("#FInputParameters").val());
                form.append("FRequire",$("#FRequire").val());
                $.ajax({
                    // type: 'POST',
                    // contentType: 'application/json',
                    // url: '/s/courseenrollment/addcourseEnrollmentzaixian', // 调用地址
                    // data: JSON.stringify(data),
                    // async: false,
                    url: '/s/courseenrollment/enrollmentupmobanpl',
                    type: 'POST',
                    data: form,
                    cache: false,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.result == 'success') {
                            //如果成功以后 ， 等待查询结果
                            setTimeout(function () {
                                $('.mloading-text').html('正在批量获取评价结果...');
                                $.ajax({
                                    type: 'POST',
                                    contentType: 'application/json;charset=UTF-8',
                                    url: '/s/courseenrollment/selectzaixianjgpl',
                                    data: JSON.stringify({
                                        id: data.ai_id
                                    }),
                                    success: function (data) {
                                        if (data.result == 'success') {
                                            parent.$('#mainTable').DataTable().ajax.reload(null, false);
                                            parent.toastr.success('评价完成！');
                                            layer_close();
                                            $("body").mLoading("hide");
                                        }
                                        if (data.result == 'error') {
                                            toastr.error(data.error);
                                            $("body").mLoading("hide");
                                        }
                                    },
                                    error: function (e) {
                                        toastr.error(e.status);
                                        toastr.error(e.responseText);
                                        $("body").mLoading("hide");
                                    }
                                });
                            }, 1000);

                        } else if (data.result == 'error') {
                            toastr.error(data.error);
                            $("body").mLoading("hide");
                        }
                    },
                    error: function (e) {
                        toastr.error(e.status);
                        toastr.error(e.responseText);
                        $("body").mLoading("hide");
                    }
                });

            }
        });
    });


    function yulanmodel() {
        if (FJKID) {
            layer_show('预览评价模版', '/module/capability/courseOffering/enrollmentscore/yulaninterface.html?FJKID=' + FJKID, '', '');
        } else {
            toastr.error("请先选择评价模版！");
        }

    }
</script>
</body>
</html>