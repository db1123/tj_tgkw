<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--_global 公共配置文件 -->
    <script language="javascript">var golbal_type = "admin";</script>
    <script type="text/javascript" src="/javascript/global.js"></script><!--/_global 公共配置文件-->
    <!--_only 独立样式 -->
    <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/plugins/select2-ztree/bootstrapStyle.css"/>
    <link rel="stylesheet" href="/plugins/jquery-jsonview/jquery.jsonview.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css"/>
    <link rel="stylesheet" href="/nui-ad/lib/datatables/1.10.15/styling/base_style/jquery.dataTables.min.css">
    <!--    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/demo.css" type="text/css">-->
    <link rel="stylesheet" href="/nui-ad/lib/zTree/v3/css/metroStyle/metroStyle.css" type="text/css">
    <!--/_only 独立样式 -->
</head>
<style type="text/css">
    ul.ztree {
        margin-left: 20px;
        border: 1px solid #617775;
        background: #f0f6e4;
        width: 92vw;
        height: 69vh;
        overflow-y: scroll;
        overflow-x: auto;
    }

    /* 自定义图标样式 */
    .ztree li a span[class*="_ico_open"],
    .ztree li a span[class*="_ico_close"],
    .ztree li a span[class*="_ico_docu"] {
        background-size: 18px 18px; /* 背景图片的大小 */
        width: 18px;
        height: 18px;
    }

    .ztree li a span.school-icon_ico_open,
    .ztree li a span.school-icon_ico_close,
    .ztree li a span.school-icon_ico_docu {
        background-image: url("/module/capability/ability/images/ability.png") !important;
    }

    .ztree li a span.college-icon_ico_open,
    .ztree li a span.college-icon_ico_close,
    .ztree li a span.college-icon_ico_docu {
        background-image: url("/module/capability/ability/images/dengji.png") !important;
    }

    .ztree li a span.major-icon_ico_open,
    .ztree li a span.major-icon_ico_close,
    .ztree li a span.major-icon_ico_docu {
        background-image: url("/module/capability/ability/images/tiaojian.png") !important;
    }

    .ztree li a span.class-icon_ico_docu {
        background-image: url("/module/capability/ability/images/kaohe.png") !important;
    }

    .ztree li a span[class*="_bt"] {
        background-size: 16px 16px; /* 调整图标大小 */
        width: 16px;
        height: 16px;
        display: inline-block;
        vertical-align: middle;
        margin-left: 5px; /* 调整按钮与文本的间距 */
        cursor: pointer; /* 设置鼠标指针为手型 */
    }

    /* 定义编辑按钮图标样式 */
    .ztree li a span.studentadd-button_bt,
    #addstudent {
        background-image: url("/module/capability/ability/images/mti_add.png") !important;
    }


    iframe {
        width: 60vw;
        height: 60vh;
        border: none; /* 去掉 iframe 的边框 */
    }
</style>
<body>
<div class="page-container">
    <div class="f-l " style="width: 98.8%; padding-top: 1px;">
        <div class="row cl">
            <div class="col-md-12">
                <div class="card-body">
                    <div class="zTreeDemoBackground left">
                        <!--                        <input type="text" id="key" value="" class="empty input-text" placeholder="请输入关键字"-->
                        <!--                               style="margin-left: 19px;width: 405px;"/><br/>-->
                        <ul id="treeDemo" class="ztree"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/jquery.ztree.exhide-3.5.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/zTree/v3/js/fuzzysearch.js"></script>
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree.js"></script>
<script type="text/javascript" src="/plugins/select2-ztree/select2-ztree-search.js"></script>
<script type="text/javascript" src="/plugins/jquery-jsonview/jquery.jsonview.js"></script>
<script src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript" src="/nui-ad/lib/datatables/1.10.15/jquery.dataTables.min.js"></script>
<script type="text/javascript">

    var zNodes = [];
    var treesetting = {};
    var treeObj = null;

    var abilityConditionsTree;
    var fpname;
    var FCID = getQueryStringByName('FCID');
    var ftype = getQueryStringByName('ftypes');

    var fjdname;

    var treeObj;


    // 业务代码
    $(function () {
        treesetting = {
            view: {
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
                selectedMulti: false,
                showIcon: true // 显示图标
            },
            check: {
                enable: false
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: false
            },

        };
        gettreedata(1);

    });

    function addHoverDom(treeId, treeNode) {
        var sObj = $("#" + treeNode.tId + "_span");
        if (treeNode.ftype == 1) {
            //能力等级
            if ($("#addBtn_" + treeNode.tId).length > 0) return

            var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                + "' title='新增考核条件子级信息' onfocus='this.blur();'></span>";
            sObj.after(addStr);
            var btn = $("#addBtn_" + treeNode.tId);
            if (btn) btn.bind("click", function () {
                xmname = rename(treeNode.name);
                fjdname = treeNode.name;
                //新增能力等级下考核条件
                var index = layer.open({
                    type: 2,
                    area: ['800px', '500px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '新增考核条件子级信息',
                    content: '/module/capability/ability/abilityCondition/tiaojianedit2.html?op=1&FAbilityLevelID=' + treeNode.FAbilityLevelID + '&FPID=' + treeNode.id + '&ftype=' + treeNode.ftype + '&op=1&tree2=1'+'&showtype=1'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });


        } else if (treeNode.ftype == 2) {//考核条件

            if ($("#delBtn3_" + treeNode.tId).length > 0) return;
            if ($("#addBtn3_" + treeNode.tId).length > 0) return;
            var addStr2 = "<span class='button add' id='addBtn3_" + treeNode.tId
                + "' title='新增考核子条件' onfocus='this.blur();'></span>";
            var delStr2 = "<span class='button remove' id='delBtn3_" + treeNode.tId
                + "' title='删除考核子条件''></span>";
            var upStr2 = "<span class='button edit' id='upBtn3_" + treeNode.tId
                + "' title='编辑考核子条件''></span>";
            sObj.after(delStr2);
            sObj.after(upStr2);
            sObj.after(addStr2);
            var btn = $("#addBtn3_" + treeNode.tId);
            if (btn) btn.bind("click", function () {
                xmname = rename(treeNode.name);
                fjdname = treeNode.name;
                //新增能力等级下考核条件
                var index = layer.open({
                    type: 2,
                    area: ['800px', '500px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '新增考核条件子级信息',
                    content: '/module/capability/ability/abilityCondition/tiaojianedit2.html?op=1&FAbilityLevelID=' + treeNode.FAbilityLevelID + '&FPID=' + treeNode.id + '&ftype=' + treeNode.ftype + '&op=1&tree2=1'+'&showtype=1'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });
            var btn2 = $("#delBtn3_" + treeNode.tId);
            if (btn2) btn2.bind("click", function () {
                xmname = rename(treeNode.name);
                ftypeid = treeNode.id;
                $(".typename").text("已选考核条件：" + xmname);
                onClickBtnuserlcDel(ftypeid, xmname, 2);
                return false;
            });
            var btn3 = $("#upBtn3_" + treeNode.tId);
            if (btn3) btn3.bind("click", function () {
                xmname = rename(treeNode.name);
                fjdname = treeNode.name;
                //新增能力等级下考核条件
                var index = layer.open({
                    type: 2,
                    area: ['800px', '500px'],
                    fix: false, //不固定
                    shade: 0.4,
                    title: '修改考核条件子级信息',
                    content: '/module/capability/ability/abilityCondition/tiaojianedit2.html?op=2&id=' + treeNode.id + '&ftype=' + treeNode.ftype + '&tree3=1&tree=1'+'&showtype=1'
                    , end: function () {
                        gettreedata(2);
                    }
                });
                // layer.full(index);
                return false;
            });

        }
    }

    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_" + treeNode.tId).unbind().remove();

        $("#addBtn3_" + treeNode.tId).unbind().remove();
        $("#delBtn3_" + treeNode.tId).unbind().remove();
        $("#upBtn3_" + treeNode.tId).unbind().remove();
    }

    function gettreedata(type) {
        $.ajax({
            type: 'POST',
            contentType: 'application/json;charset=UTF-8',
            url: '/s/abilityconditions/querabilitytiaojiantree',
            data: JSON.stringify({
                FCID: FCID,
                ftype: ftype
            }),
            success: function (data) {
                if (data.result == 'success') {
                    zNodes = data.zNodes;
                    if (type == 1) {
                        treeObj = $.fn.zTree.init($("#treeDemo"), treesetting, zNodes);
                        // fuzzySearch('treeDemo', '#key', null, true); //初始化模糊搜索方法
                    } else if (type == 2) {
                        updateTree(zNodes);
                        // $("#key").val("");
                        // // 如果关键字存在，重新触发搜索
                        // if (searchKeyword) {
                        //     $("#key").val(searchKeyword); // 设置关键字到输入框
                        //     // fuzzySearch('treeDemo', '#key', null, true, 2); //初始化模糊搜索方法
                        // }
                    }


                    // treeObj.expandAll(true);
                    // var nodes = treeObj.getSelectedNodes();
                    //
                    // if (nodes.length > 0) {
                    //     for (var i = 0; i < nodes.length; i++) {
                    //         treeObj.expandNode(nodes[i], true, true, true);
                    //     }
                    // }
                }
            },
            error: function (e) {
                toastr.error(e.status);
                toastr.error(e.responseText);
            }
        });
    }

    // 更新 zTree 数据
    function updateTree(newNodes) {
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");

        // 获取当前选中的节点
        var selectedNodes = treeObj.getSelectedNodes();
        var selectedNodeId = selectedNodes.length > 0 ? selectedNodes[0].id : null;

        // 获取当前展开的节点
        var expandedNodes = [];
        var allNodes = treeObj.transformToArray(treeObj.getNodes());
        allNodes.forEach(function (node) {
            if (node.open) {
                expandedNodes.push(node.id);
            }
        });

        // 清空当前树
        treeObj.destroy();

        // 重新初始化 zTree
        treeObj = $.fn.zTree.init($("#treeDemo"), treesetting, newNodes);

        // 恢复展开状态
        expandedNodes.forEach(function (id) {
            var node = treeObj.getNodeByParam("id", id);
            if (node) {
                treeObj.expandNode(node, true, false, false);
            }
        });

        // 恢复选中状态
        if (selectedNodeId) {
            var selectedNode = treeObj.getNodeByParam("id", selectedNodeId);
            if (selectedNode) {
                treeObj.selectNode(selectedNode);
            }
        }
    }


    function shuaxin() {
        $('#mainTable').DataTable().ajax.reload(null, false);
    }

    function shuaxin2() {
        gettreedata(2);
    }

    function rename(name) {
        var newname;
        newname = name.replace(/<span[^>]*>([\s\S]*?)<\/span>/g, '$1');
        return newname;
    }

    function onClickBtnuserlcDel(id, name, ftype) {
        var url = "";
        if (ftype == 1) {
            url = '/s/abilitycondition/delabilityCondition';
        } else {
            url = '/s/abilityconditions/delabilityConditions';
        }
        //考核条件删除
        layer.confirm('<b>' + name + '</b><br />确定要删除吗?', function (index) {
            $.ajax({
                type: 'POST',
                contentType: 'application/json;charset=UTF-8',
                url: url,
                data: JSON.stringify({
                    id: id
                }),
                success: function (data) {
                    if (data.result == 'success') {
                        // $('#mainTablelevelCondition').DataTable().ajax.reload(null, false);
                        shuaxin2();
                        toastr.success('删除成功！');
                        layer.close(layer.index);

                    }
                    if (data.result == 'error') {
                        toastr.error(data.error);
                    }
                },
                error: function (e) {
                    toastr.error(e.status);
                    toastr.error(e.responseText);
                }
            });
        });
    }
</script>
</body>
</html>